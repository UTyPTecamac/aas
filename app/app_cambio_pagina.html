<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor PDF 3D FlipBook Profesional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Ajuste: reducir a la mitad el espacio inferior para la barra de progreso */
        body { padding-bottom: 10px; }

        .pdf-title {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(0, 0, 0, 0.8);
            font-size: 1.1rem;
            font-weight: 600;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        all 0.3s ease;
        }

        .pdf-title.show {
            opacity: 1;
            transform: translateY(0);
        }

        .side-menu {
            position: fixed;
            top: 60px;
            right: -350px;
            width: 350px;
            height: calc(100vh - 60px);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow-y: auto;
            padding: 20px;
        }

        .side-menu.open {
            right: 0;
        }

        .menu-toggle {
            position: fixed;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            color: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            z-index: 2100;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .menu-toggle:hover {
            background: rgba(120, 119, 198, 0.15);
            transform: scale(1.1);
            color: rgba(120, 119, 198, 1);
        }

        .menu-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .menu-section:last-child {
            border-bottom: none;
        }

        .menu-title {
            color: rgba(0, 0, 0, 0.8);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .file-input-menu {
            padding: 20px;
            border: 2px dashed rgba(120, 119, 198, 0.4);
            border-radius: 15px;
            background: rgba(120, 119, 198, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-input-menu:hover {
            border-color: rgba(255, 119, 198, 0.6);
            background: rgba(255, 119, 198, 0.1);
        }

        .file-icon-menu {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .file-text-menu {
            color: rgba(0, 0, 0, 0.7);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .file-subtext-menu {
            color: rgba(0, 0, 0, 0.5);
            font-size: 0.75rem;
        }

        .url-input-section input[type="url"] {
            transition: all 0.3s ease;
        }

        .url-input-section input[type="url"]:focus {
            outline: none;
            border-color: rgba(120, 119, 198, 0.8);
            background: rgba(120, 119, 198, 0.1);
            box-shadow: 0 0 10px rgba(120, 119, 198, 0.3);
        }

        .url-input-section input[type="url"]::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .loading {
            display: none;
            text-align: center;
            color: rgba(0, 0, 0, 0.8);
            font-size: 24px;
            margin: 50px 0;
            position: relative;
            z-index: 10;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading.show {
            opacity: 1;
            transform: translateY(0);
        }

        .loading.text-updating {
            transition: opacity 0.2s ease;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 6px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #7877c6;
            animation: spin 1s ease-in-out infinite;
            margin-left: 25px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            z-index: 3000;
            max-width: 400px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.3);
            font-size: 1rem;
            border: none;
            outline: none;
            opacity: 0;
            animation: fadeInDown 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards,
                       shake 0.6s ease-in-out 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(calc(-50% - 10px)) translateY(0); }
            75% { transform: translateX(calc(-50% + 10px)) translateY(0); }
        }

        .menu-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .menu-btn {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-height: 36px;
        }

        .menu-btn:hover {
            background: rgba(120, 119, 198, 0.15);
            color: rgba(120, 119, 198, 1);
            border-color: rgba(120, 119, 198, 0.3);
            transform: translateY(-1px);
        }

        .menu-btn:disabled {
            background: rgba(0, 0, 0, 0.02);
            color: rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
            transform: none;
            border-color: rgba(0, 0, 0, 0.05);
        }

        .page-info-menu {
            color: rgba(0, 0, 0, 0.7);
            font-size: 0.9rem;
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }

        .page-info-menu.fade-out {
            opacity: 0;
            transform: translateY(-5px);
        }

        .page-info-menu.fade-in {
            opacity: 0;
            transform: translateY(5px);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .zoom-controls-menu {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-btn-menu {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            min-width: 32px;
            height: 32px;
        }

        .zoom-btn-menu:hover {
            background: rgba(120, 119, 198, 0.15);
            color: rgba(120, 119, 198, 1);
            border-color: rgba(120, 119, 198, 0.3);
        }

        .zoom-level-menu {
            color: rgba(0, 0, 0, 0.7);
            font-size: 0.8rem;
            min-width: 45px;
            text-align: center;
            position: relative;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }

        .zoom-level-menu.fade-out {
            opacity: 0;
            transform: translateY(-3px);
        }

        .zoom-level-menu.fade-in {
            opacity: 0;
            transform: translateY(3px);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .flipbook-container {
            display: none;
            position: relative;
            z-index: 10;
            margin: 70px 0 30px 0; /* 60px toolbar + 10px de espacio */
            padding-top: 0;
            perspective: 2000px;
            transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .flipbook-container.book-closed {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        .flipbook-container.book-closed .flipbook {
            position: relative;
            left: 0;
            right: 0;
            margin: 0;
        }

        .flipbook-container.book-open {
            display: block;
        }

        .flipbook {
            position: relative;
            margin: 0 auto;
            transform-style: preserve-3d;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: top center;
        }

        .book-spine {
            position: absolute;
            left: 50%;
            top: 0;
            width: 20px;
            height: 100%;
            background: transparent;
            transform: translateX(-50%) rotateY(90deg);
            box-shadow: none;
            z-index: 5;
        }

        .book-page {
            position: absolute;
            background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.3),
                inset 0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,0.9);
            transform-origin: left center;
            transition: opacity 0.4s ease,
                        transform 0.4s ease;
            backface-visibility: hidden;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-style: preserve-3d;
            opacity: 0;
        }

        .book-page.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
            transition: opacity 0.25s ease;
        }

        .book-page.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 10;
            transition: opacity 0.3s ease;
        }

        .book-page.flipping {
            z-index: 20;
            transition: none; /* Sin transici√≥n durante el volteo para evitar conflictos */
        }

        /* Nuevas clases para posicionamiento sin conflictos */
        .book-page.centered {
            right: 50% !important;
            left: auto !important;
            transform: translateX(50%) !important;
            transform-origin: left center !important;
        }

        .book-page.position-left {
            left: 0 !important;
            right: auto !important;
            transform: none !important;
            transform-origin: right center !important;
        }

        .book-page.position-right {
            right: 0 !important;
            left: auto !important;
            transform: none !important;
            transform-origin: left center !important;
        }

        /* Esquinas CSS naturales e integradas */
        .book-page::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 15;
            pointer-events: none;
        }

        /* P√°gina izquierda - esquina inferior izquierda m√°s grande y visible */
        .book-page.left::before {
            bottom: -1px;
            left: -1px;
            border-right: 40px solid transparent;
            border-bottom: 40px solid #e8e8e8;
            border-top: 0;
            border-left: 0;
            box-shadow: 
                5px 5px 12px rgba(0,0,0,0.25),
                inset -3px -3px 8px rgba(0,0,0,0.15),
                2px 2px 6px rgba(0,0,0,0.1);
            transform: rotate(0deg);
            border-radius: 0 0 0 3px;
        }

        /* P√°gina derecha - esquina inferior derecha m√°s grande y visible */
        .book-page.right::before {
            bottom: -1px;
            right: -1px;
            border-left: 40px solid transparent;
            border-bottom: 40px solid #e8e8e8;
            border-top: 0;
            border-right: 0;
            box-shadow: 
                -5px 5px 12px rgba(0,0,0,0.25),
                inset 3px -3px 8px rgba(0,0,0,0.15),
                -2px 2px 6px rgba(0,0,0,0.1);
            transform: rotate(0deg);
            border-radius: 0 0 3px 0;
        }

        /* Efecto hover m√°s notorio */
        .book-page:hover::before {
            opacity: 0.95;
            transform: scale(1.15);
        }

        /* L√≠nea de pliegue m√°s larga y visible */
        .book-page::after {
            content: '';
            position: absolute;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 16;
            pointer-events: none;
            width: 50px;
            height: 1px;
        }

        .book-page.left::after {
            bottom: 39px;
            left: 39px;
            background: linear-gradient(-45deg, transparent, rgba(0,0,0,0.3), transparent);
            transform: rotate(-45deg);
            transform-origin: center;
        }

        .book-page.right::after {
            bottom: 39px;
            right: 39px;
            background: linear-gradient(45deg, transparent, rgba(0,0,0,0.3), transparent);
            transform: rotate(45deg);
            transform-origin: center;
        }

        .book-page:hover::after {
            opacity: 0.7;
        }

        /* Sombra base de las p√°ginas */
        .book-page.left {
            left: 0;
            border-radius: 12px 0 0 12px;
            transform-origin: right center;
            background: linear-gradient(90deg, 
                #ffffff 0%, 
                #ffffff 85%, 
                #f8f8f8 90%, 
                #f0f0f0 95%, 
                #e8e8e8 100%);
        }

        .book-page.right {
            right: 0;
            border-radius: 0 12px 12px 0;
            transform-origin: left center;
            background: linear-gradient(90deg, 
                #e8e8e8 0%, 
                #f0f0f0 5%, 
                #f8f8f8 10%, 
                #ffffff 15%, 
                #ffffff 100%);
        }

        .book-page.flipping.right {
            animation: flipRight 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .book-page.flipping.left {
            animation: flipLeft 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Animaci√≥n espec√≠fica para portada abri√©ndose */
        .book-page.flipping.cover-opening {
            animation: coverOpening 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Animaci√≥n espec√≠fica para cerrar el libro */
        .book-page.flipping.cover-closing {
            animation: coverClosing 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes flipRight {
            0% {
                transform: rotateY(0deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
            20% {
                transform: rotateY(-45deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    -10px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            50% {
                transform: rotateY(-90deg) translateZ(20px) scaleX(0.9);
                box-shadow: 
                    0 30px 60px rgba(0,0,0,0.4),
                    -15px 0 25px rgba(0,0,0,0.25),
                    inset 0 0 0 1px rgba(255,255,255,0.5);
            }
            80% {
                transform: rotateY(-135deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    -10px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            100% {
                transform: rotateY(-180deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
        }

        @keyframes flipLeft {
            0% {
                transform: rotateY(0deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
            20% {
                transform: rotateY(45deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    10px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            50% {
                transform: rotateY(90deg) translateZ(20px) scaleX(0.9);
                box-shadow: 
                    0 30px 60px rgba(0,0,0,0.4),
                    15px 0 25px rgba(0,0,0,0.25),
                    inset 0 0 0 1px rgba(255,255,255,0.5);
            }
            80% {
                transform: rotateY(135deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    10px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            100% {
                transform: rotateY(180deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
        }

        @keyframes coverOpening {
            0% {
                transform: translateX(50%) rotateY(0deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
            25% {
                transform: translateX(25%) rotateY(-45deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    -8px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            50% {
                transform: translateX(0%) rotateY(-90deg) translateZ(20px) scaleX(0.9);
                box-shadow: 
                    0 30px 60px rgba(0,0,0,0.4),
                    -15px 0 25px rgba(0,0,0,0.25),
                    inset 0 0 0 1px rgba(255,255,255,0.5);
            }
            75% {
                transform: translateX(0%) rotateY(-135deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    -8px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            100% {
                transform: translateX(0%) rotateY(-180deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
        }

        @keyframes coverClosing {
            0% {
                transform: translateX(0%) rotateY(-180deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
            25% {
                transform: translateX(0%) rotateY(-135deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    -8px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            50% {
                transform: translateX(0%) rotateY(-90deg) translateZ(20px) scaleX(0.9);
                box-shadow: 
                    0 30px 60px rgba(0,0,0,0.4),
                    -15px 0 25px rgba(0,0,0,0.25),
                    inset 0 0 0 1px rgba(255,255,255,0.5);
            }
            75% {
                transform: translateX(25%) rotateY(-45deg) translateZ(15px) scaleX(0.95);
                box-shadow: 
                    0 25px 50px rgba(0,0,0,0.35),
                    -8px 0 20px rgba(0,0,0,0.2),
                    inset 0 0 0 1px rgba(255,255,255,0.7);
            }
            100% {
                transform: translateX(50%) rotateY(0deg) translateZ(2px) scaleX(1);
                box-shadow: 
                    0 20px 40px rgba(0,0,0,0.3),
                    inset 0 0 0 1px rgba(255,255,255,0.8);
            }
        }

        .page-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            position: relative;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .book-page.visible .page-content {
            opacity: 1;
            transition: opacity 0.3s ease 0.1s;
        }

        .page-content canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s forwards;
        }

        .welcome-text {
            font-size: 1.5rem;
            margin-bottom: 10px;
            opacity: 0;
            color: rgba(0, 0, 0, 0.8);
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .welcome-subtext {
            font-size: 1rem;
            opacity: 0;
            margin-bottom: 30px;
            color: rgba(0, 0, 0, 0.6);
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.6s forwards;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .open-menu-hint {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.8s forwards;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        @media (max-width: 1200px) {
            .header h1 {
                font-size: 2.8rem;
            }
            
            .main-controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .file-input-container {
                padding: 30px 20px;
            }
            
            .main-controls {
                padding: 20px 30px;
            }
            
            .control-btn {
                padding: 15px 20px;
                font-size: 14px;
            }
        }

        /* Barra de herramientas minimalista superior */
        .top-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0 20px;
            opacity: 0;
            transform: translateY(-100%);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .top-toolbar.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 15px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: rgba(120, 119, 198, 0.15);
            color: rgba(120, 119, 198, 1);
            border-color: rgba(120, 119, 198, 0.3);
            transform: translateY(-1px);
        }

        .toolbar-btn:disabled {
            background: rgba(0, 0, 0, 0.02);
            color: rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
            transform: none;
            border-color: rgba(0, 0, 0, 0.05);
        }

        .toolbar-btn.active {
            background: rgba(120, 119, 198, 0.2);
            color: rgba(120, 119, 198, 1);
            border-color: rgba(120, 119, 198, 0.4);
            box-shadow: 0 2px 8px rgba(120, 119, 198, 0.2);
        }

        .zoom-display {
            color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            font-weight: 500;
            min-width: 50px;
            text-align: center;
            position: relative;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }

        .zoom-display.fade-out {
            opacity: 0;
            transform: translateY(-3px);
        }

        .zoom-display.fade-in {
            opacity: 0;
            transform: translateY(3px);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .page-info {
            color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
            position: relative;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }

        .page-info.fade-out {
            opacity: 0;
            transform: translateY(-5px);
        }

        .page-info.fade-in {
            opacity: 0;
            transform: translateY(5px);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Ajustar el contenedor principal para la barra superior */
        .flipbook-container {
            margin-top: 80px;
        }

        /* Ocultar el men√∫ lateral cuando la barra superior est√° visible */
        .side-menu {
            top: 60px;
            height: calc(100vh - 60px);
        }
    </style>
</head>
<body>
    <div class="pdf-title" id="pdfTitle">Sin documento</div>
    
    <!-- Barra de herramientas superior minimalista -->
    <div class="top-toolbar" id="topToolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" id="firstPageToolbar" title="Inicio">‚èÆÔ∏è</button>
            <button class="toolbar-btn" id="prevPageToolbar" title="Anterior">‚¨ÖÔ∏è</button>
            <button class="toolbar-btn" id="nextPageToolbar" title="Siguiente">‚û°Ô∏è</button>
            <button class="toolbar-btn" id="lastPageToolbar" title="√öltimo">‚è≠Ô∏è</button>
        </div>
        
        <div class="toolbar-group">
            <span class="page-info" id="pageInfoToolbar">P√°gina 1 de 1</span>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" id="zoomOutToolbar" title="Zoom Out">-</button>
            <span class="zoom-display" id="zoomLevelToolbar">100%</span>
            <button class="toolbar-btn" id="zoomInToolbar" title="Zoom In">+</button>
            <button class="toolbar-btn" id="fitScreenToolbar" title="Ajustar a pantalla">üìê</button>
            <button class="toolbar-btn" id="panToolbar" title="Mover documento">‚úã</button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" id="qualityLowToolbar" title="Calidad Baja">L</button>
            <button class="toolbar-btn" id="qualityMediumToolbar" title="Calidad Media">M</button>
            <button class="toolbar-btn" id="qualityHighToolbar" title="Calidad Alta">H</button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" id="fullscreenToolbar" title="Pantalla completa">üî≥</button>
        </div>
    </div>
    
    <button class="menu-toggle" id="menuToggle" title="Opciones">‚öôÔ∏è</button>
    
            <div class="side-menu" id="sideMenu">
        <div class="menu-section" id="navigationSection" style="display: none;">
            <div class="menu-title">Navegaci√≥n</div>
            <div class="page-info-menu" id="pageInfoMenu">P√°gina 1 de 1</div>
            <div class="menu-controls">
                <div class="control-row">
                    <button class="menu-btn" id="prevBtnMenu">‚¨ÖÔ∏è Anterior</button>
                    <button class="menu-btn" id="nextBtnMenu">Siguiente ‚û°Ô∏è</button>
                </div>
                <div class="control-row">
                    <button class="menu-btn" id="firstPageBtn">‚èÆÔ∏è Inicio</button>
                    <button class="menu-btn" id="lastPageBtn">Fin ‚è≠Ô∏è</button>
                </div>
            </div>
        </div>

        <div class="menu-section" id="zoomSection" style="display: none;">
            <div class="menu-title">Zoom</div>
            <div class="zoom-controls-menu">
                <button class="zoom-btn-menu" id="zoomOutBtnMenu">-</button>
                <span class="zoom-level-menu" id="zoomLevelMenu">100%</span>
                <button class="zoom-btn-menu" id="zoomInBtnMenu">+</button>
                <button class="zoom-btn-menu" id="fitBtnMenu">üìê</button>
                <button class="zoom-btn-menu" id="panBtnMenu">‚úã</button>
            </div>
            <div class="quality-controls-menu" style="margin-top: 10px;">
                <div class="menu-title" style="font-size: 0.8rem; margin-bottom: 8px;">Calidad</div>
                <div class="control-row">
                    <button class="menu-btn" id="qualityLowBtn" style="font-size: 0.75rem;">Baja</button>
                    <button class="menu-btn" id="qualityMediumBtn" style="font-size: 0.75rem;">Media</button>
                    <button class="menu-btn" id="qualityHighBtn" style="font-size: 0.75rem;">Alta</button>
                </div>
            </div>
        </div>

        <div class="menu-section" id="optionsSection" style="display: none;">
            <div class="menu-title">Opciones</div>
            <div class="menu-controls">
                <button class="menu-btn" id="fullscreenBtnMenu">üî≥ Pantalla completa</button>
            </div>
        </div>
    </div>

    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-icon">üìö</div>
        <div class="welcome-text">Ebook Viewer</div>
        <div class="welcome-subtext">Cargando ebook...</div>
    </div>

    <div class="loading" id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; background: rgba(255,255,255,0.95); padding: 30px 40px; border-radius: 15px; color: rgba(0,0,0,0.8); box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-size: 18px; font-weight: 500;">
        Cargando ebook...
    </div>

    <div class="error-message" id="errorMessage">
        Error al cargar el PDF. Verifica que el archivo sea v√°lido y no est√© protegido.
    </div>

    <div class="flipbook-container" id="flipbookContainer">
        <div class="flipbook" id="flipbook">
            <div class="book-spine"></div>
            <!-- Las p√°ginas se crear√°n din√°micamente aqu√≠ -->
        </div>
    </div>

    <!-- Barra de progreso inferior -->
    <div id="progressBar" style="position: fixed; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(0,0,0,0.05); z-index: 2500;">
        <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(90deg, rgba(34,197,94,0.9), rgba(16,185,129,0.9)); box-shadow: 0 0 8px rgba(16,185,129,0.35);"></div>
    </div>

    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        class Professional3DFlipBookViewer {
            constructor() {
                this.pdf = null;
                this.currentPage = 1;
                this.totalPages = 0;
                this.baseScale = 1.5;
                this.zoomLevel = 1.0;
                this.isFlipping = false;
                this.qualityMultiplier = 1.5; // Calidad media por defecto
                this.isPanMode = false; // Modo pan desactivado por defecto

                this.flipDuration = 500; // Reducido de 800ms a 500ms para mayor velocidad
                this.pageElements = [];
                this.pageCanvases = [];
                this.allPagesLoaded = false;
                
                this.initializeElements();
                this.bindEvents();
                // setupDragAndDrop ya no es necesario ya que eliminamos la opci√≥n de cargar archivos
                this.setupPanMode();
                
                // Verificar si hay par√°metros pdf y zoom en la URL para carga autom√°tica y configuraci√≥n de zoom
                this.checkUrlParameter();
            }

            initializeElements() {
                this.loading = document.getElementById('loading');
                this.errorMessage = document.getElementById('errorMessage');
                this.flipbookContainer = document.getElementById('flipbookContainer');
                this.flipbook = document.getElementById('flipbook');
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.pdfTitle = document.getElementById('pdfTitle');
                this.sideMenu = document.getElementById('sideMenu');
                this.menuToggle = document.getElementById('menuToggle');
                
                // Top toolbar elements
                this.topToolbar = document.getElementById('topToolbar');
                this.firstPageToolbar = document.getElementById('firstPageToolbar');
                this.prevPageToolbar = document.getElementById('prevPageToolbar');
                this.nextPageToolbar = document.getElementById('nextPageToolbar');
                this.lastPageToolbar = document.getElementById('lastPageToolbar');
                this.pageInfoToolbar = document.getElementById('pageInfoToolbar');
                this.zoomOutToolbar = document.getElementById('zoomOutToolbar');
                this.zoomInToolbar = document.getElementById('zoomInToolbar');
                this.fitScreenToolbar = document.getElementById('fitScreenToolbar');
                this.panToolbar = document.getElementById('panToolbar');
                this.zoomLevelToolbar = document.getElementById('zoomLevelToolbar');
                this.qualityLowToolbar = document.getElementById('qualityLowToolbar');
                this.qualityMediumToolbar = document.getElementById('qualityMediumToolbar');
                this.qualityHighToolbar = document.getElementById('qualityHighToolbar');
                this.fullscreenToolbar = document.getElementById('fullscreenToolbar');
                
                // Menu controls
                this.prevBtnMenu = document.getElementById('prevBtnMenu');
                this.nextBtnMenu = document.getElementById('nextBtnMenu');
                this.firstPageBtn = document.getElementById('firstPageBtn');
                this.lastPageBtn = document.getElementById('lastPageBtn');
                this.pageInfoMenu = document.getElementById('pageInfoMenu');
                this.fullscreenBtnMenu = document.getElementById('fullscreenBtnMenu');
                this.zoomInBtnMenu = document.getElementById('zoomInBtnMenu');
                this.zoomOutBtnMenu = document.getElementById('zoomOutBtnMenu');
                this.fitBtnMenu = document.getElementById('fitBtnMenu');
                this.panBtnMenu = document.getElementById('panBtnMenu');
                this.zoomLevelMenu = document.getElementById('zoomLevelMenu');
                
                // Menu sections
                this.navigationSection = document.getElementById('navigationSection');
                this.zoomSection = document.getElementById('zoomSection');
                this.optionsSection = document.getElementById('optionsSection');
            }

            // Funci√≥n para verificar y cargar autom√°ticamente PDF desde par√°metro de URL
            checkUrlParameter() {
                const urlParams = new URLSearchParams(window.location.search);
                const pdfUrl = urlParams.get('pdf') || urlParams.get('pdfview'); // Soporte para ambos par√°metros por compatibilidad
                
                // Leer par√°metro de zoom desde la URL
                const zoomParam = urlParams.get('zoom');
                if (zoomParam) {
                    try {
                        // Convertir porcentaje a valor num√©rico (ej: 125 -> 1.25)
                        const zoomValue = parseFloat(zoomParam);
                        if (!isNaN(zoomValue) && zoomValue > 0) {
                            // Convertir porcentaje a decimal si es > 1, asumir que ya es porcentaje
                            const zoomDecimal = zoomValue >= 1 && zoomValue <= 300 ? zoomValue / 100 : zoomValue;
                            // Limitar zoom entre 50% y 300%
                            this.zoomLevel = Math.max(0.5, Math.min(3.0, zoomDecimal));
                            console.log('Zoom configurado desde URL:', this.zoomLevel);
                        }
                    } catch (error) {
                        console.warn('Error al parsear par√°metro zoom:', error);
                    }
                }
                
                if (pdfUrl) {
                    console.log('Par√°metro pdf encontrado:', pdfUrl);
                    
                    // Ocultar pantalla de bienvenida y mostrar cargador
                    if (this.welcomeScreen) {
                        this.welcomeScreen.style.display = 'none';
                    }
                    // Mostrar indicador de carga
                    this.showLoading(true);
                    this.hideError();
                    
                    // Procesar la URL para manejar casos especiales
                    let processedUrl = pdfUrl;
                    
                    // Si estamos usando protocolo file:// y la URL es relativa, convertir a absoluta
                    if (window.location.protocol === 'file:' && !pdfUrl.startsWith('http://') && !pdfUrl.startsWith('https://') && !pdfUrl.startsWith('file://')) {
                        const currentPath = window.location.pathname;
                        const basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                        processedUrl = `file://${basePath}/${pdfUrl}`;
                        console.log('URL procesada para protocolo file://:', processedUrl);
                    }
                    
                    // Intentar m√∫ltiples estrategias de carga para archivos locales
                    if (window.location.protocol === 'file:' && !pdfUrl.startsWith('http://') && !pdfUrl.startsWith('https://')) {
                        // Estrategia 1: Intentar con la URL procesada
                        this.loadPdfFromUrl(processedUrl).catch(error => {
                            console.log('Estrategia 1 fall√≥, intentando estrategia 2...', error);
                            
                            // Estrategia 2: Intentar con URL relativa simple
                            this.loadPdfFromUrl(pdfUrl).catch(error2 => {
                                console.log('Estrategia 2 fall√≥, intentando estrategia 3...', error2);
                                
                                // Estrategia 3: Intentar con ruta absoluta completa
                                const fullPath = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/' + pdfUrl;
                                this.loadPdfFromUrl(fullPath).catch(error3 => {
                                    console.error('Todas las estrategias fallaron:', error3);
                                    this.showError('No se pudo cargar el PDF. Verifica que el archivo existe y es accesible.');
                                });
                            });
                        });
                    } else {
                        // Para URLs remotas, usar la estrategia normal
                        this.loadPdfFromUrl(processedUrl);
                    }
                }
            }

            // Funci√≥n para cargar PDF desde URL (reutilizable)
            async loadPdfFromUrl(url) {
                try {
                    // Validar URL
                    if (!url) {
                        this.showError('URL no v√°lida.');
                        return;
                    }
                    
                    let finalUrl = url;
                    
                    // Manejar URLs relativas y locales
                    if (url.startsWith('./') || url.startsWith('../') || url.startsWith('/')) {
                        // URL relativa - mantener como est√°
                        finalUrl = url;
                    } else if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('file://')) {
                        // URL sin protocolo - agregar https
                        finalUrl = 'https://' + url;
                    }
                    
                    // Codificar la URL si es un archivo local para manejar espacios y caracteres especiales
                    if (finalUrl.startsWith('file://')) {
                        try {
                            // Intentar usar el constructor URL para codificar correctamente
                            const urlObj = new URL(finalUrl);
                            finalUrl = urlObj.href;
                        } catch (e) {
                            // Fallback: codificar manualmente la parte de la ruta
                            const protocol = 'file://';
                            const path = finalUrl.substring(protocol.length);
                            const encodedPath = encodeURI(path);
                            finalUrl = protocol + encodedPath;
                        }
                        console.log('URL codificada para archivo local:', finalUrl);
                    }
                    
                    console.log('Intentando cargar PDF desde:', finalUrl);
                    
                    // Cargar el PDF
                    this.pdf = await pdfjsLib.getDocument(finalUrl).promise;
                    this.totalPages = this.pdf.numPages;
                    this.currentPage = 1;
                    
                    // Extraer nombre del archivo de la URL
                    const urlParts = finalUrl.split('/');
                    const fileName = urlParts[urlParts.length - 1].replace('.pdf', '') || 'Documento PDF';
                    if (this.pdfTitle) {
                        this.pdfTitle.textContent = fileName;
                        this.pdfTitle.style.display = 'block';
                        // Forzar reflow y aplicar transici√≥n
                        void this.pdfTitle.offsetWidth;
                        this.pdfTitle.classList.add('show');
                    }
                    
                    // Configurar y mostrar el PDF
                    await this.adjustFlipbookToPDFSize();
                    await this.createAllPages();
                    await this.renderAllPages();
                    this.showCurrentPages();
                    this.showBook();
                    this.updateControls();
                    this.showMenuSections();
                    this.closeMenu();
                    
                    // Aplicar zoom si fue configurado desde la URL
                    // (Se actualiza despu√©s de que todo est√© renderizado)
                    if (this.zoomLevel !== 1.0) {
                        // Peque√±o delay para asegurar que todo est√© renderizado
                        setTimeout(() => {
                            this.updateZoom();
                        }, 100);
                    }
                    
                    console.log('PDF cargado exitosamente desde URL:', finalUrl);
                    
                } catch (error) {
                    console.error('Error detallado al cargar PDF desde URL:', error);
                    
                    let errorMessage = 'Error al cargar el PDF: ';
                    
                    if (error.name === 'InvalidPDFException') {
                        errorMessage += 'El archivo no es un PDF v√°lido.';
                    } else if (error.name === 'MissingPDFException') {
                        errorMessage += 'El PDF no se encontr√≥ en la URL especificada.';
                    } else if (error.name === 'UnexpectedResponseException') {
                        errorMessage += 'Respuesta inesperada del servidor. Posible problema de CORS.';
                    } else if (error.message.includes('CORS')) {
                        errorMessage += 'Error de CORS. El servidor no permite acceso desde este dominio.';
                    } else if (error.message.includes('NetworkError')) {
                        errorMessage += 'Error de red. Verifica la conexi√≥n y la URL.';
                    } else {
                        errorMessage += error.message || 'Error desconocido.';
                    }
                    
                    this.showError(errorMessage);
                } finally {
                    this.showLoading(false);
                }
            }

            bindEvents() {
                if (this.menuToggle) {
                    this.menuToggle.addEventListener('click', () => this.toggleMenu());
                }
                
                // Menu navigation controls
                if (this.prevBtnMenu) this.prevBtnMenu.addEventListener('click', () => this.previousPage());
                if (this.nextBtnMenu) this.nextBtnMenu.addEventListener('click', () => this.nextPage());
                if (this.firstPageBtn) this.firstPageBtn.addEventListener('click', () => this.goToFirstPage());
                if (this.lastPageBtn) this.lastPageBtn.addEventListener('click', () => this.goToLastPage());
                if (this.fullscreenBtnMenu) this.fullscreenBtnMenu.addEventListener('click', () => this.toggleFullscreen());
                
                // Menu zoom controls
                if (this.zoomInBtnMenu) this.zoomInBtnMenu.addEventListener('click', () => this.zoomIn());
                if (this.zoomOutBtnMenu) this.zoomOutBtnMenu.addEventListener('click', () => this.zoomOut());
                if (this.fitBtnMenu) this.fitBtnMenu.addEventListener('click', () => this.fitToScreen());
                if (this.panBtnMenu) this.panBtnMenu.addEventListener('click', () => this.pan());
                
                // Quality controls
                this.qualityLowBtn = document.getElementById('qualityLowBtn');
                this.qualityMediumBtn = document.getElementById('qualityMediumBtn');
                this.qualityHighBtn = document.getElementById('qualityHighBtn');
                
                if (this.qualityLowBtn) this.qualityLowBtn.addEventListener('click', () => this.setQuality('low'));
                if (this.qualityMediumBtn) this.qualityMediumBtn.addEventListener('click', () => this.setQuality('medium'));
                if (this.qualityHighBtn) this.qualityHighBtn.addEventListener('click', () => this.setQuality('high'));
                
                // Top toolbar controls
                if (this.firstPageToolbar) this.firstPageToolbar.addEventListener('click', () => this.goToFirstPage());
                if (this.prevPageToolbar) this.prevPageToolbar.addEventListener('click', () => this.previousPage());
                if (this.nextPageToolbar) this.nextPageToolbar.addEventListener('click', () => this.nextPage());
                if (this.lastPageToolbar) this.lastPageToolbar.addEventListener('click', () => this.goToLastPage());
                if (this.zoomOutToolbar) this.zoomOutToolbar.addEventListener('click', () => this.zoomOut());
                if (this.zoomInToolbar) this.zoomInToolbar.addEventListener('click', () => this.zoomIn());
                if (this.fitScreenToolbar) this.fitScreenToolbar.addEventListener('click', () => this.fitToScreen());
                if (this.panToolbar) this.panToolbar.addEventListener('click', () => this.pan());
                if (this.fullscreenToolbar) this.fullscreenToolbar.addEventListener('click', () => this.toggleFullscreen());
                
                // Quality toolbar controls
                if (this.qualityLowToolbar) this.qualityLowToolbar.addEventListener('click', () => this.setQuality('low'));
                if (this.qualityMediumToolbar) this.qualityMediumToolbar.addEventListener('click', () => this.setQuality('medium'));
                if (this.qualityHighToolbar) this.qualityHighToolbar.addEventListener('click', () => this.setQuality('high'));
                
                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (this.sideMenu && this.menuToggle && 
                        !this.sideMenu.contains(e.target) && !this.menuToggle.contains(e.target)) {
                        this.closeMenu();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (this.pdf && !this.isFlipping) {
                        switch(e.key) {
                            case 'ArrowLeft':
                                e.preventDefault();
                                this.previousPage();
                                break;
                            case 'ArrowRight':
                                e.preventDefault();
                                this.nextPage();
                                break;
                            case 'Home':
                                e.preventDefault();
                                this.goToFirstPage();
                                break;
                            case 'End':
                                e.preventDefault();
                                this.goToLastPage();
                                break;
                            case 'F11':
                                e.preventDefault();
                                this.toggleFullscreen();
                                break;
                            case 'Escape':
                                e.preventDefault();
                                if (this.isPanMode) {
                                    this.pan(); // Salir del modo pan
                                } else {
                                    this.closeMenu();
                                }
                                break;
                        }
                    }
                });

                if (this.flipbookContainer) {
                    this.flipbookContainer.addEventListener('wheel', (e) => {
                        if (e.ctrlKey) {
                            e.preventDefault();
                            if (e.deltaY < 0) {
                                this.zoomIn();
                            } else {
                                this.zoomOut();
                            }
                        }
                    });
                }
            }

            toggleMenu() {
                if (this.sideMenu) {
                    this.sideMenu.classList.toggle('open');
                }
            }

            closeMenu() {
                if (this.sideMenu) {
                    this.sideMenu.classList.remove('open');
                }
            }

            // setupDragAndDrop ya no es necesario ya que eliminamos la opci√≥n de cargar archivos locales
            // setupDragAndDrop() {
            //     const container = this.fileInput.parentElement;
            //     ...
            // }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file || file.type !== 'application/pdf') {
                    this.showError('Por favor selecciona un archivo PDF v√°lido.');
                    return;
                }

                this.showLoading(true);
                this.hideError();

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    this.totalPages = this.pdf.numPages;
                    this.currentPage = 1;
                    
                    // Mostrar nombre del PDF
                    if (this.pdfTitle) {
                        this.pdfTitle.textContent = file.name.replace('.pdf', '');
                        this.pdfTitle.style.display = 'block';
                        // Forzar reflow y aplicar transici√≥n
                        void this.pdfTitle.offsetWidth;
                        this.pdfTitle.classList.add('show');
                    }
                    
                    // Obtener dimensiones del PDF y ajustar el flipbook
                    await this.adjustFlipbookToPDFSize();
                    
                    await this.createAllPages();
                    await this.renderAllPages();
                    
                    this.showCurrentPages();
                    this.showBook();
                    this.updateControls();
                    this.showMenuSections();
                    this.closeMenu();
                    
                    // Aplicar zoom si fue configurado desde la URL
                    // (Se actualiza despu√©s de que todo est√© renderizado)
                    if (this.zoomLevel !== 1.0) {
                        // Peque√±o delay para asegurar que todo est√© renderizado
                        setTimeout(() => {
                            this.updateZoom();
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    this.showError('Error al cargar el PDF. Verifica que el archivo no est√© da√±ado o protegido.');
                } finally {
                    this.showLoading(false);
                }
            }

            showMenuSections() {
                this.navigationSection.style.display = 'block';
                this.zoomSection.style.display = 'block';
                this.optionsSection.style.display = 'block';
            }

            async createAllPages() {
                this.pageElements = [];
                this.pageCanvases = [];
                
                const existingPages = this.flipbook.querySelectorAll('.book-page');
                existingPages.forEach(page => page.remove());
                
                for (let i = 1; i <= this.totalPages; i++) {
                    const pageElement = document.createElement('div');
                    pageElement.className = 'book-page hidden';
                    pageElement.id = `page-${i}`;
                    
                    // Aplicar dimensiones din√°micas
                    pageElement.style.width = this.pageWidth + 'px';
                    pageElement.style.height = this.pageHeight + 'px';
                    
                    // L√≥gica corregida: usar clases CSS en lugar de estilos inline
                    if (i === 1) {
                        // Portada centrada cuando est√° cerrada
                        pageElement.classList.add('right', 'centered');
                    } else if (i % 2 === 0) {
                        // P√°ginas pares en el lado izquierdo
                        pageElement.classList.add('left', 'position-left');
                    } else {
                        // P√°ginas impares (excepto portada) en el lado derecho
                        pageElement.classList.add('right', 'position-right');
                    }
                    
                    const pageContent = document.createElement('div');
                    pageContent.className = 'page-content';
                    
                    const canvas = document.createElement('canvas');
                    canvas.id = `canvas-${i}`;
                    
                    pageContent.appendChild(canvas);
                    pageElement.appendChild(pageContent);
                    
                    pageElement.addEventListener('click', () => {
                        // Si est√° en modo pan, no cambiar de p√°gina
                        if (this.isPanMode) {
                            return;
                        }
                        
                        if (i === 1 || i % 2 === 1) {
                            this.nextPage();
                        } else {
                            this.previousPage();
                        }
                    });
                    
                    this.flipbook.appendChild(pageElement);
                    this.pageElements[i] = pageElement;
                    this.pageCanvases[i] = canvas;
                }
            }

            async renderAllPages() {
                const renderPromises = [];
                
                // Renderizar p√°ginas con mejor calidad y en paralelo
                for (let i = 1; i <= this.totalPages; i++) {
                    renderPromises.push(this.renderSinglePage(i));
                }
                
                // Mostrar progreso de carga
                this.showLoadingProgress(renderPromises.length);
                
                await Promise.all(renderPromises);
                this.allPagesLoaded = true;
                this.hideLoadingProgress();
            }

            showLoadingProgress(totalPages) {
                let completedPages = 0;
                let lastProgress = -1;
                let updateTimeout = null;
                
                const updateProgress = () => {
                    completedPages++;
                    const progress = Math.round((completedPages / totalPages) * 100);
                    
                    // Solo actualizar si el progreso cambi√≥
                    if (progress !== lastProgress && this.loading) {
                        lastProgress = progress;
                        const newText = `Cargando ebook... ${progress}%`;
                        
                        // Cancelar actualizaci√≥n anterior si existe
                        if (updateTimeout) {
                            clearTimeout(updateTimeout);
                        }
                        
                        // Crossfade suave para el texto de progreso
                        this.loading.style.transition = 'opacity 0.2s ease';
                        this.loading.style.opacity = '0';
                        
                        updateTimeout = setTimeout(() => {
                            if (this.loading) {
                                this.loading.textContent = newText;
                                this.loading.style.opacity = '1';
                                updateTimeout = null;
                            }
                        }, 200);
                    }
                };
                
                // Interceptar las promesas para mostrar progreso
                // Almacenar la funci√≥n updateProgress para ser llamada desde renderSinglePage
                this._progressUpdate = updateProgress;
                
                return new Promise((resolve) => {
                    const checkProgress = setInterval(() => {
                        updateProgress();
                        if (completedPages >= totalPages) {
                            clearInterval(checkProgress);
                            if (updateTimeout) clearTimeout(updateTimeout);
                            resolve();
                        }
                    }, 100);
                });
            }

            hideLoadingProgress() {
                this.loading.textContent = 'Cargando ebook...';
            }

            async renderSinglePage(pageNum) {
                try {
                    const page = await this.pdf.getPage(pageNum);
                    
                    // Calcular escala de alta resoluci√≥n para mejor calidad
                    const devicePixelRatio = window.devicePixelRatio || 1;
                    const targetScale = this.baseScale * this.zoomLevel;
                    const qualityMultiplier = this.qualityMultiplier || 1.5; // Valor por defecto
                    const highResScale = targetScale * Math.max(qualityMultiplier, devicePixelRatio);
                    
                    const viewport = page.getViewport({ scale: highResScale });
                    
                    const canvas = this.pageCanvases[pageNum];
                    const context = canvas.getContext('2d');
                    
                    // Configurar canvas para alta resoluci√≥n
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    canvas.style.width = (viewport.width / highResScale * targetScale) + 'px';
                    canvas.style.height = (viewport.height / highResScale * targetScale) + 'px';
                    
                    // Configurar contexto para m√°xima calidad
                    context.imageSmoothingEnabled = true;
                    context.imageSmoothingQuality = 'high';
                    
                    // Configuraciones adicionales para mejor calidad
                    context.textRenderingOptimization = 'optimizeQuality';
                    context.alpha = true;
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport,
                        enableWebGL: false, // Usar renderizado 2D para mejor calidad de texto
                        renderInteractiveForms: false
                    };
                    
                    await page.render(renderContext).promise;
                    
                } catch (error) {
                    console.error(`Error rendering page ${pageNum}:`, error);
                    this.clearCanvas(this.pageCanvases[pageNum]);
                }
            }

            showCurrentPages() {
                // Ocultar todas las p√°ginas suavemente
                this.pageElements.forEach((pageElement, index) => {
                    if (pageElement) {
                        pageElement.classList.remove('visible');
                        pageElement.classList.add('hidden');
                    }
                });

                // Actualizar clases del contenedor y posici√≥n del t√≠tulo
                this.updateBookLayout();

                // Mostrar las nuevas p√°ginas inmediatamente pero con transici√≥n suave
                // Usar double requestAnimationFrame para asegurar que las nuevas p√°ginas
                // comienzan su transici√≥n despu√©s de que las anteriores comienzan a desaparecer
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // Caso especial: Libro cerrado (solo portada)
                        if (this.isBookClosed()) {
                            if (this.pageElements[1]) {
                                this.pageElements[1].classList.remove('hidden');
                                this.pageElements[1].classList.add('visible');
                            }
                            return;
                        }

                        // Caso especial: √öltima p√°gina impar
                        if (this.isLastOddPage()) {
                            if (this.pageElements[this.totalPages]) {
                                this.pageElements[this.totalPages].classList.remove('hidden');
                                this.pageElements[this.totalPages].classList.add('visible');
                            }
                            return;
                        }

                        // Caso normal: Mostrar spread de p√°ginas simult√°neamente
                        const leftPageNum = this.currentPage;
                        const rightPageNum = this.currentPage + 1;

                        if (leftPageNum <= this.totalPages && this.pageElements[leftPageNum]) {
                            this.pageElements[leftPageNum].classList.remove('hidden');
                            this.pageElements[leftPageNum].classList.add('visible');
                        }

                        if (rightPageNum <= this.totalPages && this.pageElements[rightPageNum]) {
                            this.pageElements[rightPageNum].classList.remove('hidden');
                            this.pageElements[rightPageNum].classList.add('visible');
                        }
                    });
                });
            }

            updateBookLayout() {
                // Actualizar el layout del libro y la posici√≥n del t√≠tulo
                if (this.isBookClosed() || this.isLastOddPage()) {
                    // Libro cerrado o √∫ltima p√°gina impar - centrar
                    this.flipbookContainer.classList.remove('book-open');
                    this.flipbookContainer.classList.add('book-closed');
                    
                    // Ajustar posici√≥n de la portada para centrarla con transici√≥n suave
                    if (this.pageElements[1]) {
                        this.pageElements[1].classList.add('centered');
                        this.pageElements[1].classList.remove('position-left', 'position-right');
                        // Agregar transici√≥n suave para el cambio de posici√≥n
                        this.pageElements[1].style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    }
                    
                    // Si es √∫ltima p√°gina impar, tambi√©n centrarla
                    if (this.isLastOddPage() && this.pageElements[this.totalPages]) {
                        this.pageElements[this.totalPages].classList.add('centered');
                        this.pageElements[this.totalPages].classList.remove('position-left', 'position-right');
                        // Agregar transici√≥n suave para el cambio de posici√≥n
                        this.pageElements[this.totalPages].style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    }
                } else {
                    // Libro abierto - layout normal con transici√≥n suave
                    this.flipbookContainer.classList.remove('book-closed');
                    this.flipbookContainer.classList.add('book-open');
                    
                    // Restaurar posiciones normales de las p√°ginas con transici√≥n
                    this.pageElements.forEach((pageElement, index) => {
                        if (pageElement && index > 0) {
                            // Agregar transici√≥n suave para todos los cambios de posici√≥n
                            pageElement.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                            
                            if (index === 1) {
                                // Portada vuelve a su posici√≥n normal (derecha)
                                pageElement.classList.remove('centered');
                                pageElement.classList.add('position-right');
                                pageElement.classList.remove('position-left');
                            } else if (index % 2 === 0) {
                                // P√°ginas pares a la izquierda
                                pageElement.classList.remove('centered');
                                pageElement.classList.add('position-left');
                                pageElement.classList.remove('position-right');
                            } else {
                                // P√°ginas impares a la derecha
                                pageElement.classList.remove('centered');
                                pageElement.classList.add('position-right');
                                pageElement.classList.remove('position-left');
                            }
                        }
                    });
                }
                
                // Restaurar transici√≥n normal despu√©s de un tiempo
                setTimeout(() => {
                    this.pageElements.forEach((pageElement, index) => {
                        if (pageElement && index > 0) {
                            pageElement.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        }
                    });
                }, 400);
            }

            isBookClosed() {
                return this.currentPage === 1;
            }

            isLastOddPage() {
                return this.currentPage === this.totalPages && this.totalPages % 2 === 1;
            }

            async adjustFlipbookToPDFSize() {
                try {
                    // Obtener la primera p√°gina para determinar las dimensiones reales
                    const firstPage = await this.pdf.getPage(1);
                    const viewport = firstPage.getViewport({ scale: 1.0 });
                    
                    // Dimensiones originales del PDF en puntos
                    const pdfWidthPt = viewport.width;
                    const pdfHeightPt = viewport.height;
                    
                    // Calcular la relaci√≥n de aspecto real del PDF
                    const pdfAspectRatio = pdfWidthPt / pdfHeightPt;
                    
                    // Determinar el espacio disponible en pantalla
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    const availableWidth = Math.min(screenWidth * 0.85, 1600);
                    const availableHeight = Math.min(screenHeight * 0.75, 900);
                    
                    // Para el flipbook, necesitamos considerar que mostramos 2 p√°ginas lado a lado
                    // Por lo tanto, el ancho total del flipbook ser√° el doble del ancho de una p√°gina
                    let pageWidth, pageHeight;
                    
                    // Calcular dimensiones basadas en la orientaci√≥n del PDF
                    if (pdfAspectRatio > 1.4) {
                        // PDF muy horizontal (landscape) - optimizar por altura
                        pageHeight = Math.min(availableHeight, pdfHeightPt * 0.8);
                        pageWidth = pageHeight * pdfAspectRatio;
                        
                        // Verificar que el ancho total del flipbook no exceda el disponible
                        const totalWidth = pageWidth * 2;
                        if (totalWidth > availableWidth) {
                            pageWidth = availableWidth / 2;
                            pageHeight = pageWidth / pdfAspectRatio;
                        }
                    } else if (pdfAspectRatio < 0.8) {
                        // PDF muy vertical (portrait) - optimizar por ancho
                        pageWidth = Math.min(availableWidth / 2, pdfWidthPt * 0.9);
                        pageHeight = pageWidth / pdfAspectRatio;
                        
                        // Verificar que la altura no exceda el disponible
                        if (pageHeight > availableHeight) {
                            pageHeight = availableHeight;
                            pageWidth = pageHeight * pdfAspectRatio;
                        }
                    } else {
                        // PDF con proporci√≥n est√°ndar - balancear ambas dimensiones
                        const scaleByWidth = (availableWidth / 2) / pdfWidthPt;
                        const scaleByHeight = availableHeight / pdfHeightPt;
                        const optimalScale = Math.min(scaleByWidth, scaleByHeight) * 0.9;
                        
                        pageWidth = pdfWidthPt * optimalScale;
                        pageHeight = pdfHeightPt * optimalScale;
                    }
                    
                    // Aplicar l√≠mites m√≠nimos para legibilidad
                    const minPageWidth = 300;
                    const minPageHeight = 400;
                    
                    if (pageWidth < minPageWidth) {
                        pageWidth = minPageWidth;
                        pageHeight = pageWidth / pdfAspectRatio;
                    }
                    
                    if (pageHeight < minPageHeight) {
                        pageHeight = minPageHeight;
                        pageWidth = pageHeight * pdfAspectRatio;
                    }
                    
                    // Calcular dimensiones del flipbook completo
                    const flipbookWidth = pageWidth * 2;
                    const flipbookHeight = pageHeight;
                    
                    // Aplicar las dimensiones al flipbook
                    this.flipbook.style.width = flipbookWidth + 'px';
                    this.flipbook.style.height = flipbookHeight + 'px';
                    
                    // Guardar todas las dimensiones calculadas
                    this.flipbookWidth = flipbookWidth;
                    this.flipbookHeight = flipbookHeight;
                    this.pageWidth = pageWidth;
                    this.pageHeight = pageHeight;
                    this.pdfAspectRatio = pdfAspectRatio;
                    this.pdfOriginalWidth = pdfWidthPt;
                    this.pdfOriginalHeight = pdfHeightPt;
                    
                    // Calcular la escala base √≥ptima para el renderizado
                    // Aumentar significativamente la escala para mejor calidad
                    const minScaleForQuality = 2.0; // Escala m√≠nima para buena calidad
                    const calculatedScale = Math.max(pageWidth / pdfWidthPt, pageHeight / pdfHeightPt);
                    this.baseScale = Math.max(calculatedScale * 1.5, minScaleForQuality);
                    
                    console.log(`PDF Original: ${pdfWidthPt.toFixed(0)}x${pdfHeightPt.toFixed(0)}pt`);
                    console.log(`Flipbook: ${flipbookWidth.toFixed(0)}x${flipbookHeight.toFixed(0)}px`);
                    console.log(`P√°ginas: ${pageWidth.toFixed(0)}x${pageHeight.toFixed(0)}px`);
                    console.log(`Ratio: ${pdfAspectRatio.toFixed(3)}, Escala base: ${this.baseScale.toFixed(2)}`);
                    console.log(`Device Pixel Ratio: ${window.devicePixelRatio || 1}`);
                    
                } catch (error) {
                    console.error('Error ajustando tama√±o del PDF:', error);
                    // Usar dimensiones por defecto si hay error
                    this.flipbookWidth = 1280;
                    this.flipbookHeight = 720;
                    this.pageWidth = 640;
                    this.pageHeight = 720;
                    this.pdfAspectRatio = 1.78;
                    this.baseScale = 1.5;
                }
            }

            clearCanvas(canvas) {
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                const gradient = context.createRadialGradient(
                    canvas.width/2, canvas.height/2, 0,
                    canvas.width/2, canvas.height/2, Math.max(canvas.width, canvas.height)/2
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(0.7, '#f8f8f8');
                gradient.addColorStop(1, '#f0f0f0');
                context.fillStyle = gradient;
                context.fillRect(0, 0, canvas.width, canvas.height);
            }

            clearPositioningClasses(pageElement) {
                // Limpiar todas las clases de posicionamiento para evitar conflictos
                pageElement.classList.remove('centered', 'position-left', 'position-right');
            }

            async nextPage() {
                if (this.isFlipping) return;
                
                // Resetear posici√≥n de pan al cambiar p√°gina
                this.resetPanPosition();
                
                // Desde libro cerrado (portada) ir a p√°ginas 2-3
                if (this.isBookClosed()) {
                    if (this.totalPages === 1) return; // Solo hay portada
                    
                    this.isFlipping = true;
                    this.playFlipSound();
                    
                    const portadaPage = this.pageElements[1];
                    
                    // Preparar las p√°ginas siguientes antes de la animaci√≥n
                    if (this.pageElements[2]) {
                        this.pageElements[2].classList.remove('hidden');
                        this.pageElements[2].classList.add('visible');
                        this.pageElements[2].style.zIndex = '5';
                    }
                    if (this.pageElements[3]) {
                        this.pageElements[3].classList.remove('hidden');
                        this.pageElements[3].classList.add('visible');
                        this.pageElements[3].style.zIndex = '5';
                    }
                    
                    if (portadaPage) {
                        // Limpiar clases de posicionamiento antes de animar
                        this.clearPositioningClasses(portadaPage);
                        // Usar animaci√≥n espec√≠fica de apertura de portada
                        portadaPage.classList.add('flipping', 'cover-opening');
                        portadaPage.style.zIndex = '20';
                    }
                    
                    setTimeout(() => {
                        this.currentPage = 2;
                        this.showCurrentPages();
                        this.updateControls();
                    }, this.flipDuration / 2);
                    
                    setTimeout(() => {
                        if (portadaPage) {
                            portadaPage.classList.remove('flipping', 'cover-opening');
                            portadaPage.style.zIndex = '';
                        }
                        this.isFlipping = false;
                    }, 600); // Duraci√≥n de la nueva animaci√≥n de apertura
                    return;
                }
                
                // Navegaci√≥n normal
                if (this.currentPage >= this.totalPages - 1) return;
                
                this.isFlipping = true;
                this.playFlipSound();
                
                // Determinar qu√© p√°gina se voltea (siempre la p√°gina derecha)
                let flippingPage = this.pageElements[this.currentPage + 1];
                
                // Preparar las p√°ginas siguientes
                const nextLeftPage = this.currentPage + 2;
                const nextRightPage = this.currentPage + 3;
                
                if (nextLeftPage <= this.totalPages && this.pageElements[nextLeftPage]) {
                    this.pageElements[nextLeftPage].classList.remove('hidden');
                    this.pageElements[nextLeftPage].classList.add('visible');
                    this.pageElements[nextLeftPage].style.zIndex = '5';
                }
                
                if (nextRightPage <= this.totalPages && this.pageElements[nextRightPage]) {
                    this.pageElements[nextRightPage].classList.remove('hidden');
                    this.pageElements[nextRightPage].classList.add('visible');
                    this.pageElements[nextRightPage].style.zIndex = '5';
                }
                
                if (flippingPage) {
                    // Limpiar clases de posicionamiento antes de animar
                    this.clearPositioningClasses(flippingPage);
                    flippingPage.classList.add('flipping');
                    flippingPage.style.zIndex = '20';
                }
                
                setTimeout(() => {
                    this.currentPage += 2;
                    this.showCurrentPages();
                    this.updateControls();
                }, this.flipDuration / 2);
                
                setTimeout(() => {
                    if (flippingPage) {
                        flippingPage.classList.remove('flipping');
                        flippingPage.style.zIndex = '';
                    }
                    this.isFlipping = false;
                }, this.flipDuration);
            }

            async previousPage() {
                if (this.isFlipping) return;
                
                // Resetear posici√≥n de pan al cambiar p√°gina
                this.resetPanPosition();
                
                // Desde p√°ginas 2-3 volver al libro cerrado (portada)
                if (this.currentPage === 2) {
                    this.isFlipping = true;
                    this.playFlipSound();
                    
                    // Preparar la portada antes de la animaci√≥n
                    if (this.pageElements[1]) {
                        this.pageElements[1].classList.remove('hidden');
                        this.pageElements[1].classList.add('visible');
                        this.pageElements[1].style.zIndex = '5';
                    }
                    
                    const currentLeftPage = this.pageElements[2];
                    if (currentLeftPage) {
                        // Limpiar clases de posicionamiento antes de animar
                        this.clearPositioningClasses(currentLeftPage);
                        // Usar animaci√≥n espec√≠fica de cierre de portada
                        currentLeftPage.classList.add('flipping', 'cover-closing');
                        currentLeftPage.style.zIndex = '20';
                    }
                    
                    setTimeout(() => {
                        this.currentPage = 1;
                        this.showCurrentPages();
                        this.updateControls();
                    }, this.flipDuration / 2);
                    
                    setTimeout(() => {
                        if (currentLeftPage) {
                            currentLeftPage.classList.remove('flipping', 'cover-closing');
                            currentLeftPage.style.zIndex = '';
                        }
                        this.isFlipping = false;
                    }, 600); // Duraci√≥n de la nueva animaci√≥n de cierre
                    return;
                }
                
                // Navegaci√≥n normal
                if (this.currentPage <= 1) return;
                
                this.isFlipping = true;
                this.playFlipSound();
                
                // Determinar qu√© p√°gina se voltea hacia atr√°s (siempre la p√°gina izquierda)
                let flippingPage = this.pageElements[this.currentPage];
                
                // Preparar las p√°ginas anteriores
                const prevLeftPage = this.currentPage - 2;
                const prevRightPage = this.currentPage - 1;
                
                if (prevLeftPage >= 1 && this.pageElements[prevLeftPage]) {
                    this.pageElements[prevLeftPage].classList.remove('hidden');
                    this.pageElements[prevLeftPage].classList.add('visible');
                    this.pageElements[prevLeftPage].style.zIndex = '5';
                }
                
                if (prevRightPage >= 1 && this.pageElements[prevRightPage]) {
                    this.pageElements[prevRightPage].classList.remove('hidden');
                    this.pageElements[prevRightPage].classList.add('visible');
                    this.pageElements[prevRightPage].style.zIndex = '5';
                }
                
                if (flippingPage) {
                    // Limpiar clases de posicionamiento antes de animar
                    this.clearPositioningClasses(flippingPage);
                    flippingPage.classList.add('flipping');
                    flippingPage.style.zIndex = '20';
                }
                
                setTimeout(() => {
                    this.currentPage -= 2;
                    if (this.currentPage < 1) this.currentPage = 1;
                    this.showCurrentPages();
                    this.updateControls();
                }, this.flipDuration / 2);
                
                setTimeout(() => {
                    if (flippingPage) {
                        flippingPage.classList.remove('flipping');
                        flippingPage.style.zIndex = '';
                    }
                    this.isFlipping = false;
                }, this.flipDuration);
            }

            async goToFirstPage() {
                if (this.currentPage === 1) return;
                this.currentPage = 1; // Libro cerrado (portada)
                this.showCurrentPages();
                this.updateControls();
            }

            async goToLastPage() {
                let lastPage;
                if (this.totalPages % 2 === 1) {
                    // Si el total es impar, la √∫ltima p√°gina se muestra sola
                    lastPage = this.totalPages;
                } else {
                    // Si el total es par, las √∫ltimas dos p√°ginas se muestran juntas
                    lastPage = this.totalPages - 1;
                }
                
                if (this.currentPage === lastPage) return;
                this.currentPage = lastPage;
                this.showCurrentPages();
                this.updateControls();
            }

            zoomIn() {
                if (this.zoomLevel < 3.0) {
                    this.zoomLevel = Math.min(3.0, this.zoomLevel + 0.25);
                    this.updateZoom();
                }
            }

            zoomOut() {
                if (this.zoomLevel > 0.5) {
                    this.zoomLevel = Math.max(0.5, this.zoomLevel - 0.25);
                    this.updateZoom();
                }
            }

            resetZoom() {
                this.zoomLevel = 1.0;
                this.updateZoom();
            }

            fitToScreen() {
                if (!this.pdf) return;
                
                // Obtener dimensiones disponibles de la pantalla
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // Espacio disponible considerando m√°rgenes y elementos fijos
                const availableWidth = screenWidth * 0.9; // 90% del ancho de pantalla
                const availableHeight = (screenHeight - 140) * 0.9; // Restar altura del t√≠tulo y m√°rgenes
                
                // Usar las dimensiones reales del flipbook
                const bookWidth = this.flipbookWidth || 1280;
                const bookHeight = this.flipbookHeight || 720;
                
                // Calcular escalas para ajustar a pantalla
                const scaleX = availableWidth / bookWidth;
                const scaleY = availableHeight / bookHeight;
                const optimalScale = Math.min(scaleX, scaleY);
                
                // Aplicar l√≠mites de zoom y actualizar
                this.zoomLevel = Math.max(0.5, Math.min(3.0, optimalScale));
                this.updateZoom();
            }

            updateZoom() {
                const zoomText = Math.round(this.zoomLevel * 100) + '%';
                
                // Aplicar crossfade suave al cambiar zoom
                if (this.zoomLevelMenu && this.zoomLevelMenu.textContent !== zoomText) {
                    this.zoomLevelMenu.classList.add('fade-out');
                    setTimeout(() => {
                        this.zoomLevelMenu.textContent = zoomText;
                        this.zoomLevelMenu.classList.remove('fade-out');
                        this.zoomLevelMenu.classList.add('fade-in');
                        setTimeout(() => {
                            this.zoomLevelMenu.classList.remove('fade-in');
                        }, 400);
                    }, 400);
                }
                
                if (this.zoomLevelToolbar && this.zoomLevelToolbar.textContent !== zoomText) {
                    this.zoomLevelToolbar.classList.add('fade-out');
                    setTimeout(() => {
                        this.zoomLevelToolbar.textContent = zoomText;
                        this.zoomLevelToolbar.classList.remove('fade-out');
                        this.zoomLevelToolbar.classList.add('fade-in');
                        setTimeout(() => {
                            this.zoomLevelToolbar.classList.remove('fade-in');
                        }, 400);
                    }, 400);
                }
                
                // Desactivar modo pan al hacer zoom
                if (this.isPanMode) {
                    this.pan(); // Toggle para desactivar
                }
                
                if (this.pdf && this.allPagesLoaded && !this.isFlipping) {
                    // Obtener la transformaci√≥n actual para mantener la posici√≥n de pan
                    const currentTransform = this.flipbook.style.transform;
                    const translateMatch = currentTransform.match(/translate\(([^)]+)\)/);
                    let translateX = 0, translateY = 0;
                    
                    if (translateMatch) {
                        const [x, y] = translateMatch[1].split(',').map(v => parseFloat(v));
                        translateX = x || 0;
                        translateY = y || 0;
                    }
                    
                    // Mantener visible la parte superior: evitar valores positivos de translateY que empujen hacia arriba
                    const toolbarReserve = 70; // altura aproximada de la barra superior
                    const minTranslateY = 0; // no permitir que se oculte la parte superior
                    translateY = Math.max(minTranslateY, translateY);

                    // Aplicar zoom manteniendo la posici√≥n y el origen en top-center
                    this.flipbook.style.transform = `translate(${translateX}px, ${translateY}px) scale(${this.zoomLevel})`;
                    
                    // Efecto visual de confirmaci√≥n r√°pido
                    this.flipbook.style.transition = 'transform 0.2s ease-out';
                    
                    // Re-renderizar p√°ginas visibles con mejor calidad despu√©s del zoom
                    setTimeout(() => {
                        this.reRenderVisiblePages();
                    }, 250);
                    
                    // Restaurar transici√≥n normal despu√©s del zoom
                    setTimeout(() => {
                        if (!this.isFlipping) {
                            this.flipbook.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        }
                    }, 200);
                }
            }

            async reRenderVisiblePages() {
                // Re-renderizar solo las p√°ginas que est√°n actualmente visibles
                const visiblePages = [];
                
                if (this.isBookClosed()) {
                    if (this.pageElements[1]) visiblePages.push(1);
                } else if (this.isLastOddPage()) {
                    if (this.pageElements[this.totalPages]) visiblePages.push(this.totalPages);
                } else {
                    const leftPageNum = this.currentPage;
                    const rightPageNum = this.currentPage + 1;
                    
                    if (leftPageNum <= this.totalPages) visiblePages.push(leftPageNum);
                    if (rightPageNum <= this.totalPages) visiblePages.push(rightPageNum);
                }
                
                // Re-renderizar p√°ginas visibles con mejor calidad
                for (const pageNum of visiblePages) {
                    await this.renderSinglePage(pageNum);
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            updateControls() {
                // Actualizar informaci√≥n de p√°gina
                let pageText;
                if (this.isBookClosed()) {
                    pageText = `Portada - ${this.totalPages} p√°ginas`;
                } else if (this.isLastOddPage()) {
                    pageText = `P√°gina ${this.totalPages} de ${this.totalPages}`;
                } else {
                    pageText = `P√°gina ${this.currentPage}-${Math.min(this.currentPage + 1, this.totalPages)} de ${this.totalPages}`;
                }
                
                // Aplicar crossfade suave al cambiar texto de p√°gina
                if (this.pageInfoMenu && this.pageInfoMenu.textContent !== pageText) {
                    this.pageInfoMenu.classList.add('fade-out');
                    setTimeout(() => {
                        this.pageInfoMenu.textContent = pageText;
                        this.pageInfoMenu.classList.remove('fade-out');
                        this.pageInfoMenu.classList.add('fade-in');
                        setTimeout(() => {
                            this.pageInfoMenu.classList.remove('fade-in');
                        }, 400);
                    }, 400);
                }
                
                if (this.pageInfoToolbar && this.pageInfoToolbar.textContent !== pageText) {
                    this.pageInfoToolbar.classList.add('fade-out');
                    setTimeout(() => {
                        this.pageInfoToolbar.textContent = pageText;
                        this.pageInfoToolbar.classList.remove('fade-out');
                        this.pageInfoToolbar.classList.add('fade-in');
                        setTimeout(() => {
                            this.pageInfoToolbar.classList.remove('fade-in');
                        }, 400);
                    }, 400);
                }
                
                // Actualizar botones del men√∫
                this.prevBtnMenu.disabled = this.isBookClosed();
                this.firstPageBtn.disabled = this.isBookClosed();
                
                // Actualizar botones de la barra superior
                this.prevPageToolbar.disabled = this.isBookClosed();
                this.firstPageToolbar.disabled = this.isBookClosed();
                
                if (this.isBookClosed()) {
                    this.nextBtnMenu.disabled = this.totalPages <= 1;
                    this.lastPageBtn.disabled = this.totalPages <= 1;
                    this.nextPageToolbar.disabled = this.totalPages <= 1;
                    this.lastPageToolbar.disabled = this.totalPages <= 1;
                } else if (this.isLastOddPage()) {
                    this.nextBtnMenu.disabled = true;
                    this.lastPageBtn.disabled = true;
                    this.nextPageToolbar.disabled = true;
                    this.lastPageToolbar.disabled = true;
                } else {
                    this.nextBtnMenu.disabled = this.currentPage >= this.totalPages - 1;
                    this.lastPageBtn.disabled = this.currentPage >= this.totalPages - 1;
                    this.nextPageToolbar.disabled = this.currentPage >= this.totalPages - 1;
                    this.lastPageToolbar.disabled = this.currentPage >= this.totalPages - 1;
                }

                // Actualizar barra de progreso inferior
                try {
                    const fill = document.getElementById('progressFill');
                    if (fill && this.totalPages > 1) {
                        const basePage = this.isBookClosed() ? 1 : this.currentPage;
                        const position = Math.min(basePage, this.totalPages);
                        const progress = Math.max(0, Math.min(1, (position - 1) / (this.totalPages - 1)));
                        fill.style.width = (progress * 100).toFixed(1) + '%';
                    }
                } catch (e) {}
            }

            showBook() {
                this.welcomeScreen.style.display = 'none';
                
                // Mostrar barra de herramientas superior
                this.showTopToolbar();
                
                // Inicializar con el layout correcto
                this.updateBookLayout();
                
                // Transici√≥n m√°s suave y elegante
                this.flipbookContainer.style.opacity = '0';
                this.flipbookContainer.style.transform = 'translateY(30px) scale(0.95)';
                this.flipbookContainer.style.display = 'block';
                
                // Peque√±o delay para asegurar que el display se aplique
                requestAnimationFrame(() => {
                    this.flipbookContainer.style.transition = 'all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    this.flipbookContainer.style.opacity = '1';
                    this.flipbookContainer.style.transform = 'translateY(0) scale(1)';
                });
            }

            showTopToolbar() {
                this.topToolbar.classList.add('visible');
                // Ocultar el bot√≥n del men√∫ cuando la barra superior est√° visible
                this.menuToggle.style.display = 'none';
                // Inicializar calidad media como activa
                this.qualityMediumToolbar.classList.add('active');
            }

            hideTopToolbar() {
                this.topToolbar.classList.remove('visible');
                // Mostrar el bot√≥n del men√∫ cuando se oculta la barra superior
                this.menuToggle.style.display = 'block';
            }

            showLoading(show) {
                if (this.loading) {
                    if (show) {
                        this.loading.style.display = 'block';
                        // Forzar reflow para que la animaci√≥n funcione
                        void this.loading.offsetWidth;
                        this.loading.classList.add('show');
                    } else {
                        this.loading.classList.remove('show');
                        setTimeout(() => {
                            if (this.loading) {
                                this.loading.style.display = 'none';
                            }
                        }, 400);
                    }
                }
            }

            showError(message) {
                if (this.errorMessage) {
                    this.errorMessage.textContent = message;
                    this.errorMessage.style.display = 'block';
                    setTimeout(() => {
                        if (this.errorMessage) {
                            this.errorMessage.style.display = 'none';
                        }
                    }, 7000);
                }
            }

            hideError() {
                if (this.errorMessage) {
                    this.errorMessage.style.display = 'none';
                }
            }

            playFlipSound() {
                // Reproducir sonido real de voltear p√°gina
                try {
                    const audio = new Audio('https://cdn.pixabay.com/audio/2025/05/05/audio_ca4220361e.mp3');
                    audio.volume = 0.3; // Volumen moderado
                    audio.currentTime = 0; // Empezar desde el inicio
                    
                    // Reproducir el sonido
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            // Si falla la reproducci√≥n autom√°tica, crear sonido alternativo
                            console.log('Reproducci√≥n autom√°tica bloqueada, usando sonido alternativo');
                            this.createAlternativeSound();
                        });
                    }
                } catch (error) {
                    console.log('Error cargando sonido, usando alternativo');
                    this.createAlternativeSound();
                }
            }

            createAlternativeSound() {
                // Sonido alternativo usando Web Audio API si el archivo no se puede cargar
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    const filter = audioContext.createBiquadFilter();
                    
                    filter.type = 'highpass';
                    filter.frequency.setValueAtTime(800, audioContext.currentTime);
                    filter.Q.setValueAtTime(0.5, audioContext.currentTime);
                    
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.03, audioContext.currentTime + 0.08);
                    gainNode.gain.linearRampToValueAtTime(0.001, audioContext.currentTime + 0.12);
                    
                    oscillator.connect(filter);
                    filter.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.12);
                    
                } catch (error) {
                    console.log('Web Audio API no disponible');
                }
            }

            setQuality(quality) {
                // Configurar multiplicador de calidad seg√∫n la selecci√≥n
                switch(quality) {
                    case 'low':
                        this.qualityMultiplier = 1.0;
                        break;
                    case 'medium':
                        this.qualityMultiplier = 1.5;
                        break;
                    case 'high':
                        this.qualityMultiplier = 2.5;
                        break;
                    default:
                        this.qualityMultiplier = 1.5;
                }
                
                // Actualizar estado visual de los botones del men√∫
                [this.qualityLowBtn, this.qualityMediumBtn, this.qualityHighBtn].forEach(btn => {
                    btn.style.background = 'rgba(255, 255, 255, 0.1)';
                });
                
                // Actualizar estado visual de los botones de la barra superior
                [this.qualityLowToolbar, this.qualityMediumToolbar, this.qualityHighToolbar].forEach(btn => {
                    btn.classList.remove('active');
                });
                
                switch(quality) {
                    case 'low':
                        this.qualityLowBtn.style.background = 'rgba(120, 119, 198, 0.6)';
                        this.qualityLowToolbar.classList.add('active');
                        break;
                    case 'medium':
                        this.qualityMediumBtn.style.background = 'rgba(120, 119, 198, 0.6)';
                        this.qualityMediumToolbar.classList.add('active');
                        break;
                    case 'high':
                        this.qualityHighBtn.style.background = 'rgba(120, 119, 198, 0.6)';
                        this.qualityHighToolbar.classList.add('active');
                        break;
                }
                
                // Re-renderizar p√°ginas visibles con nueva calidad
                if (this.pdf && this.allPagesLoaded) {
                    this.reRenderVisiblePages();
                }
                
                console.log(`Calidad cambiada a: ${quality} (multiplicador: ${this.qualityMultiplier})`);
            }

            pan() {
                // Toggle modo pan
                this.isPanMode = !this.isPanMode;
                
                // Actualizar estado visual de los botones
                const panButtons = [this.panToolbar, this.panBtnMenu];
                panButtons.forEach(btn => {
                    if (btn) {
                        if (this.isPanMode) {
                            btn.classList.add('active');
                            btn.style.background = 'rgba(120, 119, 198, 0.8)';
                            btn.title = 'Salir modo mover (ESC)';
                        } else {
                            btn.classList.remove('active');
                            btn.style.background = 'rgba(255, 255, 255, 0.1)';
                            btn.title = 'Mover documento';
                        }
                    }
                });
                
                // Cambiar cursor del flipbook
                if (this.isPanMode) {
                    this.flipbook.style.cursor = 'grab';
                    this.flipbook.style.userSelect = 'none';
                    // Agregar indicador visual
                    this.flipbook.style.boxShadow = '0 0 20px rgba(120, 119, 198, 0.3)';
                } else {
                    this.flipbook.style.cursor = 'default';
                    this.flipbook.style.userSelect = 'auto';
                    // Remover indicador visual
                    this.flipbook.style.boxShadow = '';
                }
                
                console.log('Modo pan:', this.isPanMode ? 'activado' : 'desactivado');
            }

            setupPanMode() {
                let isDragging = false;
                let startX, startY, startTranslateX, startTranslateY;
                let hasMoved = false; // Para detectar si realmente se movi√≥
                
                // Eventos de mouse para pan
                this.flipbook.addEventListener('mousedown', (e) => {
                    if (!this.isPanMode || this.isFlipping) return;
                    
                    isDragging = true;
                    hasMoved = false;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // Obtener posici√≥n actual del flipbook
                    const transform = this.flipbook.style.transform;
                    const translateMatch = transform.match(/translate\(([^)]+)\)/);
                    if (translateMatch) {
                        const [translateX, translateY] = translateMatch[1].split(',').map(v => parseFloat(v));
                        startTranslateX = translateX || 0;
                        startTranslateY = translateY || 0;
                    } else {
                        startTranslateX = 0;
                        startTranslateY = 0;
                    }
                    
                    this.flipbook.style.cursor = 'grabbing';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging || !this.isPanMode) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    // Detectar si realmente se movi√≥ (m√°s de 5px)
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        hasMoved = true;
                    }
                    
                    const newTranslateX = startTranslateX + deltaX;
                    const newTranslateY = startTranslateY + deltaY;
                    
                    // Aplicar transformaci√≥n manteniendo el zoom
                    const currentTransform = this.flipbook.style.transform;
                    const scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
                    const scale = scaleMatch ? scaleMatch[1] : '1';
                    
                    this.flipbook.style.transform = `translate(${newTranslateX}px, ${newTranslateY}px) scale(${scale})`;
                });
                
                document.addEventListener('mouseup', (e) => {
                    if (isDragging && this.isPanMode) {
                        this.flipbook.style.cursor = 'grab';
                        
                        // Si se movi√≥ significativamente, prevenir el click en la p√°gina
                        if (hasMoved) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }
                    isDragging = false;
                    hasMoved = false;
                });
            }

            resetPanPosition() {
                // Resetear la posici√≥n de pan cuando se cambia de p√°gina
                const currentTransform = this.flipbook.style.transform;
                const scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
                const scale = scaleMatch ? scaleMatch[1] : '1';
                
                this.flipbook.style.transform = `scale(${scale})`;
                
                // Desactivar modo pan autom√°ticamente al cambiar p√°gina
                if (this.isPanMode) {
                    this.pan(); // Toggle para desactivar
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new Professional3DFlipBookViewer();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96eb5ec140c6d87a',t:'MTc1NTEyMTIxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
