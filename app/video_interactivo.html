<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Interactivo Avanzado - UX Mejorada</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
        /* SISTEMA DE DISEÑO UNIFICADO */
        :root {
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 24px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 40px;
            
            --color-primary: #1768ac;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ff9500;
            --color-dark: #2d3748;
            --color-gray: #4a5568;
            --color-light: #e2e8f0;
            --color-white: #ffffff;
            --color-black: #000000;
        }

        /* ESTILOS BASE */
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: transparent; 
            overflow: hidden; 
        }

        /* CONTENEDOR PRINCIPAL */
        .container {
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            background: transparent; 
            border: none; 
            box-shadow: none;
            border-radius: 0;
            padding: var(--spacing-sm);
            box-sizing: border-box;
        }

        /* BARRA DE PROGRESO SUPERIOR */
        .progress-bar {
            background: #e6e6e6;
            height: 6px;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            position: relative;
            margin-bottom: var(--spacing-sm);
        }

        .progress-fill {
            background: var(--color-black);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            border-radius: var(--border-radius-sm);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: #333333;
        }

        /* CONTENEDOR DE VIDEO - MEJORADO */
        .video-container {
            width: 100%;
            flex: 1;
            min-height: 0;
            position: relative;
            background: var(--color-black);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: var(--border-radius-lg);
            margin: 0;
        }
        
        /* WRAPPER DE PROPORCIÓN 16:9 - MEJORADO */
        .video-aspect-wrapper {
            width: 100%;
            max-width: 100%;
            height: auto;
            max-height: 100%;
            aspect-ratio: 16 / 9;
            position: relative;
            margin: auto;
            border-radius: var(--border-radius-md);
            overflow: hidden;
        }

        /* ELEMENTOS DE VIDEO - MEJORADOS */
        .video-player,
        .video-overlay-blocker,
        .video-state-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: inherit;
        }
        
        .video-player {
            object-fit: contain;
        }

        .video-overlay-blocker {
            z-index: 5;
            cursor: pointer;
            display: none;
        }

        /* OVERLAY DE ESTADO - MEJORADO */
        .video-state-overlay {
            z-index: 6; 
            background: var(--color-black); 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            color: var(--color-white);
            opacity: 1;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        
        .video-state-overlay.hidden {
            display: none;
            opacity: 0;
        }

        /* ELEMENTOS DE SPLASH SCREEN - MEJORADOS */
        .splash-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-white);
            margin-bottom: var(--spacing-lg);
        }

        .splash-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: var(--spacing-lg);
        }

        .splash-play-button {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-white);
            transition: all 0.2s ease;
            font-size: 50px;
        }
        
        .video-state-overlay.error .splash-play-button {
            display: none;
        }
        
        .video-state-overlay.error .splash-title {
            color: var(--color-danger);
        }
        
        .video-state-overlay.loading .splash-play-button {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--color-white);
            animation: spin 1s linear infinite;
        }
        .video-state-overlay.loading .splash-play-button .material-icons {
            display: none;
        }
        
        .splash-play-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        /* OVERLAYS DE INTERACCIÓN - MEJORADOS */
        .question-overlay, .info-overlay, .feedback-overlay, .results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .feedback-overlay { z-index: 1001; }
        .results-overlay { z-index: 1002; }

        /* TARJETAS DE OVERLAY - MEJORADAS */
        .question-card, .info-card, .feedback-card, .results-card {
            background: var(--color-white);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: none;
            animation: slideIn 0.4s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .question-card, .info-card {
            width: 80%;
            height: 80%;
            max-width: 1000px;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .info-card {
            max-width: 800px;
            height: auto;
            max-height: 80%;
        }
        
        .feedback-card, .results-card {
            width: 90%;
            height: auto;
            max-width: 500px;
            max-height: 90%;
            text-align: center;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .feedback-card {
            animation: bounceIn 0.6s ease-out;
        }
        
        .results-card {
            padding: var(--spacing-2xl);
            animation: bounceIn 0.6s ease-out;
        }

        .feedback-card.correct {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 3px solid var(--color-success);
        }

        .feedback-card.incorrect {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 3px solid var(--color-danger);
        }

        /* ICONOS DE FEEDBACK - MEJORADOS */
        .feedback-icon {
            font-size: 0;
            margin-bottom: var(--spacing-xl);
            animation: iconPulse 0.8s ease-out;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .feedback-icon .material-icons {
            font-size: 150px;
            line-height: 1;
        }

        .feedback-icon.correct {
            color: var(--color-white);
            background: linear-gradient(135deg, var(--color-success), #20c997);
        }

        .feedback-icon.incorrect {
            color: var(--color-white);
            background: linear-gradient(135deg, var(--color-danger), #e74c3c);
        }
        
        /* RESULTADOS - MEJORADOS */
        .results-icon {
            font-size: 60px;
            margin-bottom: var(--spacing-lg);
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--color-white);
            animation: iconPulse 0.8s ease-out;
        }
        
        .results-icon.excellent { background: linear-gradient(135deg, var(--color-success), #20c997); }
        .results-icon.good { background: linear-gradient(135deg, var(--color-primary), #0f5c9c); }
        .results-icon.improve { background: linear-gradient(135deg, var(--color-warning), #ffc107); }
        
        .results-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--color-dark);
            margin-bottom: var(--spacing-lg);
        }
        
        .results-score-ring {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: var(--spacing-sm) auto var(--spacing-xl);
            background: var(--color-light);
            position: relative;
        }
        
        .results-score-ring.animate {
            animation: fill-ring 1.5s 0.3s ease-out forwards;
        }

        @keyframes fill-ring {
            from {
                background: conic-gradient(var(--color-light) 0deg, var(--color-light) 360deg);
            }
            to {
                background: conic-gradient(var(--ring-color) 0deg, var(--ring-color) var(--ring-percentage), var(--color-light) var(--ring-percentage));
            }
        }

        .results-score-inner {
            width: 160px;
            height: 160px;
            background: var(--color-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .results-percentage {
            font-size: 48px;
            font-weight: bold;
            color: var(--color-dark);
            opacity: 0;
            transform: scale(0.5);
            animation: bounceIn 0.6s 1s ease-out forwards;
        }
        
        .results-details {
            font-size: 18px;
            color: var(--color-gray);
            margin-bottom: var(--spacing-sm);
        }
        
        .results-message {
            font-size: 16px;
            color: var(--color-gray);
            line-height: 1.5;
            margin-bottom: var(--spacing-xl);
            max-width: 350px;
        }
        
        /* ELIMINADO: loading-overlay (ya no se usa) */
        .loading-overlay {
            display: none !important;
        }
        
        /* ENCABEZADOS DE TARJETAS - MEJORADOS */
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-light);
        }

        .card-icon {
            font-size: 48px;
            color: var(--color-primary);
            margin-right: var(--spacing-md);
        }

        .card-info {
            flex: 1;
        }
        
        .card-counter {
            color: var(--color-gray);
            font-size: 16px;
            font-weight: 600;
            background: #f7fafc;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            border: 2px solid var(--color-light);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-content {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-md);
        }
        
        .card-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-top: var(--spacing-md);
            border-top: 2px solid var(--color-light);
        }

        /* ANIMACIONES */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes iconPulse {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            30% { transform: scale(1.3) rotate(-90deg); opacity: 0.7; }
            60% { transform: scale(0.9) rotate(0deg); opacity: 0.9; }
            80% { transform: scale(1.1) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* CONTENIDO DE INTERACCIÓN - MEJORADO */
        .interaction-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .interaction-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: var(--spacing-xl);
            line-height: 1.4;
        }
        
        .interaction-text {
            font-size: 18px;
            line-height: 1.6;
            color: var(--color-gray);
            margin-bottom: var(--spacing-xl);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex: 1;
        }

        .option-button {
            background: var(--color-white);
            border: 3px solid var(--color-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg) var(--spacing-xl);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            color: var(--color-dark);
            position: relative;
            display: flex;
            align-items: center;
            min-height: 60px;
        }

        .option-button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .option-button.selected {
            background: #ebf8ff;
            border-color: var(--color-primary);
            color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23,104,172,0.2);
        }

        .option-button.correct {
            background: #f0fff4;
            border-color: var(--color-success);
            color: #22543d;
            animation: correctAnswer 0.6s ease-out;
        }

        .option-button.correct::before {
            content: '✓';
            color: var(--color-success);
            font-weight: bold;
            font-size: 24px;
            margin-right: var(--spacing-sm);
        }

        .option-button.incorrect {
            background: #fff5f5;
            border-color: var(--color-danger);
            color: #742a2a;
            animation: incorrectAnswer 0.6s ease-out;
        }

        .option-button.incorrect::before {
            content: '✗';
            color: var(--color-danger);
            font-weight: bold;
            font-size: 24px;
            margin-right: var(--spacing-sm);
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #c6f6d5; }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        
        /* RELACIÓN DE COLUMNAS - MEJORADO */
        .matching-container {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-lg);
            flex: 1;
        }
        
        .matching-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .matching-column-header {
            font-weight: bold;
            text-align: center;
            padding: var(--spacing-sm);
            background: #f7fafc;
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--color-light);
        }
        
        .column-item {
            background: #f7fafc;
            border: 2px solid var(--color-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 16px;
            color: var(--color-dark);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .column-item::before {
            content: attr(data-number);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--color-primary);
            color: var(--color-white);
            border-radius: 50%;
            font-weight: bold;
            margin-right: var(--spacing-sm);
            flex-shrink: 0;
        }
        
        .column-item:hover {
            border-color: #cbd5e0;
            background: var(--color-white);
        }
        
        .column-item.selected {
            border-color: var(--color-primary);
            background: #ebf8ff;
            box-shadow: 0 4px 12px rgba(23,104,172,0.2);
            transform: scale(1.03);
        }
        
        .column-item.paired-a {
            background: #ebf8ff;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        
        .column-item.paired-b {
            background: #ebf8ff;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .column-item.correct {
            background: #f0fff4;
            border-color: var(--color-success);
            color: #22543d;
        }
        
        .column-item.incorrect {
            background: #fff5f5;
            border-color: var(--color-danger);
            color: #742a2a;
        }

        /* BOTONES - MEJORADOS */
        .submit-btn, .continue-btn {
            background: var(--color-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 160px;
            justify-content: center;
        }

        .submit-btn:hover, .continue-btn:hover {
            background: #0f5c9c;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23,104,172,0.3);
        }

        .submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            color: #a0aec0;
            transform: none;
            box-shadow: none;
        }

        .continue-btn {
            background: var(--color-success);
        }

        .continue-btn:hover {
            background: #218838;
            box-shadow: 0 8px 25px rgba(40,167,69,0.3);
        }

        /* BARRA DE CONTROLES - MEJORADA */
        .controls {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--color-black);
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .play-pause-btn {
            background: var(--color-primary);
            color: var(--color-white);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .play-pause-btn:hover {
            background: #0f5c9c;
        }
        
        .play-pause-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .play-pause-btn:disabled:hover {
            background: #cbd5e0;
        }

        .time-display {
            color: var(--color-white);
            font-size: 14px;
            font-weight: 500;
            margin-left: var(--spacing-sm);
            font-family: 'Courier New', monospace;
            min-width: 100px;
        }

        .time-display span {
            color: var(--color-white);
        }

        .interactive-markers {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
            margin: 0 var(--spacing-md);
        }

        .markers-container {
            position: relative;
            flex: 1;
            height: 8px;
            background: #e6e6e6;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .markers-container:hover {
            height: 12px;
            margin: -2px 0;
        }

        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--color-primary);
            border-radius: var(--border-radius-sm);
            width: 0%;
            transition: width 0.1s ease;
            pointer-events: none;
        }

        .timeline-handle {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: var(--color-primary);
            border: 3px solid var(--color-white);
            border-radius: 50%;
            cursor: grab;
            transform: translateX(-50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            z-index: 5;
        }

        .timeline-handle:hover {
            transform: translateX(-50%) scale(1.2);
            background: #0f5c9c;
        }

        .timeline-handle:active {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.3);
        }

        .marker {
            position: absolute;
            top: -2px;
            width: 12px;
            height: 12px;
            background: var(--color-primary);
            border: 2px solid var(--color-white);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 3;
        }

        .marker:hover {
            transform: scale(1.3);
            background: #0f5c9c;
            z-index: 4;
        }

        .marker.completed {
            background: #5cb85c;
            animation: completedPulse 0.5s ease-out;
        }

        .marker.approaching {
            background: var(--color-warning);
            animation: approachingPulse 1.5s infinite;
            transform: scale(1.2);
        }

        .marker.active {
            background: #ff4444;
            animation: activePulse 1s infinite;
            transform: scale(1.4);
        }

        @keyframes completedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        @keyframes approachingPulse {
            0%, 100% { 
                transform: scale(1.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.4);
                box-shadow: 0 4px 12px rgba(255, 149, 0, 0.6);
            }
        }

        @keyframes activePulse {
            0%, 100% { 
                transform: scale(1.4);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.6);
                box-shadow: 0 6px 16px rgba(255, 68, 68, 0.8);
            }
        }

        .marker-tooltip {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: var(--color-white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .marker:hover .marker-tooltip {
            opacity: 1;
        }

        .timeline-tooltip {
            position: absolute;
            bottom: 25px;
            background: rgba(0,0,0,0.9);
            color: var(--color-white);
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
            transform: translateX(-50%);
        }

        .markers-label {
            font-size: 12px;
            color: var(--color-white);
            white-space: nowrap;
        }

        .control-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        .control-btn {
            background: transparent;
            border: 1px solid #555;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: normal;
            color: var(--color-white);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn:hover {
            border-color: #777;
            background: rgba(255,255,255,0.1);
        }

        .control-btn.icon-only {
            padding: var(--spacing-sm);
            min-width: 36px;
            justify-content: center;
        }

        .dropdown-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: var(--color-white);
            border: 1px solid #ddd;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 120px;
            margin-bottom: var(--spacing-sm);
            display: none;
        }

        .dropdown-item {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: 13px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: #333;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item.active {
            background: #e8f4fd;
            color: var(--color-primary);
        }

        .control-btn {
            position: relative;
        }

        .feedback {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            font-weight: normal;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .feedback.correct {
            background: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }

        .feedback.correct::before {
            content: '✓';
            color: #5cb85c;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .feedback.incorrect {
            background: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }

        .feedback.incorrect::before {
            content: '✗';
            color: #d9534f;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        /* RESPONSIVE - MEJORADO */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                padding: var(--spacing-xs);
            }
            
            .question-card, .feedback-card, .info-card, .results-card {
                width: 95%;
                height: 90%;
                padding: var(--spacing-xl);
            }
            
            .header {
                padding: var(--spacing-lg);
            }
            
            .header h1 {
                font-size: 24px;
            }

            .interaction-title {
                font-size: 20px;
            }
            
            .results-title {
                font-size: 28px;
            }
            
            .results-score-ring {
                width: 150px;
                height: 150px;
            }
            
            .results-score-inner {
                width: 120px;
                height: 120px;
            }
            
            .results-percentage {
                font-size: 36px;
            }

            .option-button {
                font-size: 16px;
                padding: var(--spacing-md) var(--spacing-lg);
            }

            .feedback-title {
                font-size: 24px;
            }

            .feedback-message {
                font-size: 16px;
            }

            .feedback-icon {
                font-size: 80px;
                margin-bottom: var(--spacing-md);
            }

            .feedback-card {
                padding: var(--spacing-xl);
                max-height: 80%;
            }
            
            .matching-container {
                flex-direction: column;
            }
            
            .video-container {
                border-radius: var(--border-radius-md);
            }
        }

        /* PANTALLAS ESTRECHAS - MEJORADO */
        @media (max-width: 400px) {
            .controls {
                padding: var(--spacing-sm) var(--spacing-xs);
                gap: var(--spacing-sm);
            }
            .interactive-markers {
                margin: 0 var(--spacing-sm);
            }
            .markers-label {
                display: none;
            }
            .time-display {
                min-width: 80px;
                margin-left: var(--spacing-xs);
            }
            .video-controls {
                gap: var(--spacing-sm);
            }
            .control-buttons {
                gap: var(--spacing-xs);
            }
            .control-btn.icon-only {
                padding: 6px;
                min-width: 30px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="container">
   <div class="header" style="display: none;">
    <p id="video-description">Responde las preguntas que aparecen durante el video</p>
   </div>
   <div class="progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
   </div>

   <!-- CONTENEDOR DE VIDEO MEJORADO -->
   <div class="video-container">
       <div class="video-aspect-wrapper">
            <video id="video-player" 
                   class="video-player" 
                   preload="metadata" 
                   playsinline>
            </video>
            
            <div class="video-overlay-blocker" id="video-overlay-blocker"></div>

            <div class="video-state-overlay" id="video-state-overlay">
                <span class="splash-title">Video Interactivo</span>
                <div class="splash-play-button">
                    <span class="material-icons" style="font-size: 50px; color: white;">play_arrow</span>
                </div>
                <span class="splash-subtitle">Presiona para iniciar</span>
            </div>
       </div>
   </div>
    
    <!-- OVERLAYS -->
    <div class="info-overlay" id="info-overlay">
     <div class="info-card">
        <div class="card-header">
           <div class="card-icon"><span class="material-icons">info</span></div>
           <div class="card-info">
                <div class="interaction-title" id="info-title"></div>
           </div>
        </div>
        <div class="card-content" id="info-content">
        </div>
        <div class="card-actions">
            <button class="continue-btn" id="info-continue-btn">
                <span class="material-icons">play_arrow</span> Continuar
            </button>
        </div>
     </div>
    </div>
    
    <div class="question-overlay" id="question-overlay">
     <div class="question-card">
      <div class="card-header">
       <div class="card-icon"><span class="material-icons">quiz</span></div>
       <div class="card-info">
        <div class="card-counter" id="question-counter">Pregunta 1 de 5</div>
       </div>
      </div>
      <div class="card-content" id="interaction-content">
      </div>
      <div class="card-actions">
          <button class="submit-btn" id="submit-btn" disabled>
            <span class="material-icons">send</span> Responder
          </button>
      </div>
     </div>
    </div>
    
    <div class="feedback-overlay" id="feedback-overlay">
     <div class="feedback-card" id="feedback-card">
      <div class="feedback-icon" id="feedback-icon"><span class="material-icons">check_circle</span>
      </div>
      <div class="feedback-title" id="feedback-title">
       ¡Correcto!
      </div>
      <div class="feedback-message" id="feedback-message">
       ¡Excelente! Has respondido correctamente.
      </div><button class="continue-btn" id="feedback-continue-btn"> <span class="material-icons">play_arrow</span> Continuar </button>
     </div>
    </div>
    
    <div class="results-overlay" id="results-overlay">
     <div class="results-card" id="results-card">
        <div class="results-icon" id="results-icon">
            <span class="material-icons">emoji_events</span>
        </div>
        <div class="results-title" id="results-title">¡Resultados!</div>
        
        <div class="results-score-ring" id="results-score-ring">
            <div class="results-score-inner">
                <span class="results-percentage" id="results-percentage">100%</span>
            </div>
        </div>
        
        <div class="results-details" id="results-details">
            Puntos: 5 / 5
        </div>
        <div class="results-message" id="results-message">
            Mensaje de retroalimentación.
        </div>
        
        <button class="continue-btn" id="results-continue-btn">
            <span class="material-icons">check</span> Finalizar
        </button>
     </div>
    </div>

   <!-- BARRA DE CONTROLES MEJORADA -->
   <div class="controls">
    <div class="video-controls"><button class="play-pause-btn" id="play-pause-btn"> <span class="material-icons">play_arrow</span> </button>
     <div class="time-display" id="time-display"><span id="current-time">0:00</span> / <span id="total-time">0:00</span>
     </div>
    </div>
    <div class="interactive-markers"><span class="markers-label">Actividades:</span>
     <div class="markers-container" id="markers-container">
      <div class="timeline-progress" id="timeline-progress"></div>
      <div class="timeline-handle" id="timeline-handle"></div>
      <div class="timeline-tooltip" id="timeline-tooltip">
       0:00
      </div>
     </div>
    </div>
    <div class="control-buttons"><button class="control-btn icon-only" id="audio-btn" title="Silenciar/Activar audio"> <span class="material-icons">volume_up</span> </button> <button class="control-btn icon-only" id="fullscreen-btn" title="Pantalla completa"> <span class="material-icons">fullscreen</span> </button> <button class="control-btn icon-only" id="restart-btn" title="Reiniciar video"> <span class="material-icons">replay</span> </button> <button class="control-btn icon-only" id="results-btn" title="Ver resultados"> <span class="material-icons">assessment</span> </button>
    </div>
   </div>
  </div>
  
  <!-- JavaScript Completo -->
  <script>
        // Configuración por defecto
        const defaultConfig = {
            video_description: "Responde las preguntas que aparecen durante el video"
        };

        // Datos de ejemplo (fallback)
        let interactionsData = {
            "video_url": "https://storage.googleapis.com/interactive-video-gemini-test/video-example.mp4",
            "questions": [
                {
                    "id": 1,
                    "time": 5,
                    "type": "text_media",
                    "content": {
                        "title": "(EJEMPLO) ¡Bienvenido!",
                        "text": "Este es un video MP4 estándar. El video se pausará para mostrarte información o preguntas.",
                        "image": null
                    }
                },
                {
                    "id": 2,
                    "time": 15,
                    "type": "multiple_choice",
                    "points": 1,
                    "content": {
                        "question": "(EJEMPLO) ¿Qué tipo de video es este?",
                        "options": ["YouTube", "Vimeo", "HTML5 <video>"],
                        "correct_answer": 2,
                        "feedback": {
                            "correct": "¡Correcto! Ahora usamos un elemento <video> de HTML5.",
                            "incorrect": "Incorrecto. Ya no dependemos de YouTube."
                        }
                    }
                }
            ]
        };

        // Variables globales
        let questions = [];
        let currentInteractionIndex = 0;
        let selectedAnswer = null;
        let userMatches = [];
        let selectedColumnA = null;
        
        let questionsAnswered = 0;
        let userScore = 0;
        let totalPossiblePoints = 0;
        
        let isPlaying = false;
        let currentVideoTime = 0;
        let videoDuration = 0;
        let isMuted = false;
        
        let videoElement = null;
        let videoReady = false;
        let isDragging = false;
        
        let isInteractionActive = false;
        
        let videoUrl = null;
        let jsonFile = null;
        let videoUrlParamProvided = false;
        
        let hasAttemptedFallback = false;

        // --- Funciones de Audio ---
        function createAudioFeedback(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let frequencies = [];
            let baseDelay = 0.1;
            let duration = 0.4;
            let waveType = 'sine';
            
            switch(type) {
                case 'correct':
                    frequencies = [523.25, 659.25, 783.99];
                    break;
                case 'incorrect':
                    frequencies = [400, 200];
                    waveType = 'sawtooth';
                    duration = 0.5;
                    break;
                case 'results_excellent':
                    frequencies = [523, 659, 783, 1046];
                    baseDelay = 0.08;
                    duration = 0.5;
                    break;
                case 'results_good':
                    frequencies = [523, 659, 783];
                    baseDelay = 0.1;
                    duration = 0.5;
                    break;
                case 'results_bad':
                    frequencies = [523, 440, 392];
                    baseDelay = 0.12;
                    duration = 0.5;
                    break;
                default:
                    return;
            }

            frequencies.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                oscillator.type = waveType;
                
                const startTime = audioContext.currentTime + (index * baseDelay);
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration + 0.1);
            });
        }

        // --- Funciones de Utilidad ---
        
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoParam = urlParams.get('video');
            const jsonParam = urlParams.get('json');
            
            if (videoParam) {
                videoUrl = decodeURIComponent(videoParam);
                videoUrlParamProvided = true; 
            }
            if (jsonParam) {
                jsonFile = decodeURIComponent(jsonParam);
            }
        }
        
        // --- Lógica de Carga e Inicialización ---
        
        function initializeVideoPlayer(url) {
            if (!videoElement) {
                console.error("videoElement no está definido.");
                showSplashError('Error Crítico', 'El reproductor de video no existe en el HTML.');
                return;
            }
            
            console.log('PASO 3: Inicializando el reproductor de video HTML5 con URL:', url);
            updateSplashLoading(true, 'Preparando Video...');
            
            videoElement.removeEventListener('loadedmetadata', onVideoReady);
            videoElement.removeEventListener('error', onVideoError);
            videoElement.removeEventListener('play', onVideoPlay);
            videoElement.removeEventListener('pause', onVideoPause);
            videoElement.removeEventListener('ended', onVideoEnded);
            videoElement.removeEventListener('timeupdate', onVideoTimeUpdate);

            videoElement.addEventListener('loadedmetadata', onVideoReady);
            videoElement.addEventListener('error', onVideoError);
            videoElement.addEventListener('play', onVideoPlay);
            videoElement.addEventListener('pause', onVideoPause);
            videoElement.addEventListener('ended', onVideoEnded);
            videoElement.addEventListener('timeupdate', onVideoTimeUpdate);
            
            videoElement.src = url;
            videoElement.load();
        }

        function onVideoReady(event) {
            console.log('PASO 4: El reproductor de video está listo (loadedmetadata).');
            videoReady = true;
            hasAttemptedFallback = false;

            updateSplashLoading(false);
            
            document.getElementById('video-overlay-blocker').style.display = 'block';
            document.getElementById('play-pause-btn').disabled = false;
            
            try {
                videoDuration = videoElement.duration;
                updateTimeDisplay();
                createInteractiveMarkers();
            } catch (error) {
                console.warn('No se pudo obtener la duración, usando 180s por defecto.', error);
                videoDuration = 180;
                createInteractiveMarkers();
            }
        }

        function onVideoError(event) {
            console.error('Error del reproductor de video:', videoElement.error);
            let subtext = 'No se pudo cargar el video.';
            
            if (videoElement.error && videoElement.error.code) {
                 switch (videoElement.error.code) {
                    case MediaError.MEDIA_ERR_ABORTED:
                        subtext = 'La carga del video fue abortada.';
                        break;
                    case MediaError.MEDIA_ERR_NETWORK:
                        subtext = 'Error de red al cargar el video.';
                        break;
                    case MediaError.MEDIA_ERR_DECODE:
                        subtext = 'Error al decodificar el video (posible códec corrupto).';
                        break;
                    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        subtext = 'El formato del video no es compatible.';
                        
                        if (!hasAttemptedFallback) {
                            hasAttemptedFallback = true;
                            const fallbackUrl = interactionsData.video_url || "https://storage.googleapis.com/interactive-video-gemini-test/video-example.mp4";
                            console.warn(`Error de códec. Intentando cargar video de respaldo: ${fallbackUrl}`);
                            showSplashError('Error de Códec', 'El video principal no es compatible. Cargando video de respaldo...');
                            setTimeout(() => {
                                initializeVideoPlayer(fallbackUrl);
                            }, 1500);
                            return;
                        }
                        subtext = 'El video principal Y el video de respaldo no son compatibles.';
                        break;
                    default:
                        subtext = 'Ocurrió un error desconocido.';
                }
            }
            showSplashError('Error de Video', subtext);
        }

        function onVideoPlay(event) {
            const stateOverlay = document.getElementById('video-state-overlay'); 
            isPlaying = true;
            document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">pause</span>';
            stateOverlay.classList.remove('visible'); 
            stateOverlay.style.display = 'none';
        }
        
        function onVideoPause(event) {
            const stateOverlay = document.getElementById('video-state-overlay'); 
            isPlaying = false;
            document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">play_arrow</span>';
            
            if (!isInteractionActive) {
                stateOverlay.classList.add('visible'); 
            }
        }

        function onVideoEnded(event) {
            isPlaying = false;
            document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">replay</span>';
            
            document.getElementById('video-state-overlay').classList.remove('visible'); 
            
            showResults();
        }
        
        function onVideoTimeUpdate(event) {
            if (!videoReady || !videoElement) return;
            
            currentVideoTime = videoElement.currentTime;
            const currentTimeSeconds = Math.floor(currentVideoTime);
            updateTimelineProgress();
            updateTimeDisplay();
            
            if (isPlaying) {
                if (questions && questions.length > 0) {
                    questions.forEach((interaction, index) => {
                        if (currentTimeSeconds >= interaction.time && currentTimeSeconds < interaction.time + 1 && !interaction.shown) {
                            interaction.shown = true;
                            showInteraction(index);
                        }
                    });
                }
            }
        }

        function setupEventListeners() {
            document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
            
            const blocker = document.getElementById('video-overlay-blocker');
            if (blocker) {
                blocker.addEventListener('click', togglePlayPause);
            }
            
            const stateOverlay = document.getElementById('video-state-overlay');
            if (stateOverlay) {
                stateOverlay.addEventListener('click', togglePlayPause);
            }
            
            document.getElementById('audio-btn').addEventListener('click', toggleAudio);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            document.getElementById('restart-btn').addEventListener('click', restartVideo);
            document.getElementById('results-btn').addEventListener('click', showResults);
            
            document.getElementById('submit-btn').addEventListener('click', submitAnswer);
            document.getElementById('feedback-continue-btn').addEventListener('click', continueVideo);
            document.getElementById('info-continue-btn').addEventListener('click', continueVideo);
            document.getElementById('results-continue-btn').addEventListener('click', () => {
                document.getElementById('results-overlay').style.display = 'none';
                isInteractionActive = false; 
                document.getElementById('video-state-overlay').classList.add('visible');
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('play-pause-btn').disabled = true;
            
            videoElement = document.getElementById('video-player');
            
            console.log('DOM Listo. Cargando datos...');
            updateSplashLoading(true, 'Cargando Datos...');
            
            getUrlParams();
            
            setupEventListeners();
            
            await loadQuestionsData();
            
            updateProgress();
        });
        
        async function fetchWithRetries(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(url, { 
                        signal: controller.signal, 
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        return await response.json();
                    }
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText} al intentar cargar ${url}`); 
                } catch (error) {
                    console.error(`Error cargando JSON (intento ${i + 1}/${retries}):`, error);
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                }
            }
        }
        
        async function loadQuestionsData() {
            console.log('PASO 2: Intentando cargar JSON desde:', jsonFile);
            updateSplashLoading(true, 'Cargando Preguntas...'); 
            
            let loadedData = null;
            let jsonLoadError = null;

            if (jsonFile) {
                try {
                    loadedData = await fetchWithRetries(jsonFile, 3);
                    
                    if (!loadedData || typeof loadedData !== 'object') {
                         throw new Error('JSON descargado no es un objeto válido (no es un objeto o está vacío).');
                    }
                    if (!loadedData.questions) {
                        throw new Error('JSON inválido: Falta la propiedad "questions" de nivel superior.');
                    }
                    
                    console.log('PASO 2.1: JSON cargado y validado.');
                    
                } catch (error) {
                    jsonLoadError = error.message;
                    console.error('FALLO al cargar/validar el JSON:', jsonLoadError);
                    loadedData = null;
                }
            }
            
            if (loadedData) {
                interactionsData = loadedData;
            } else {
                 if (jsonLoadError) {
                    showSplashError('Advertencia de Interacciones', `No se pudo cargar el JSON. Razón: ${jsonLoadError}. Se usarán las preguntas de ejemplo.`);
                 } else {
                     console.warn('Usando datos de ejemplo internos para las preguntas.');
                 }
            }
            
            const jsonVideoUrl = interactionsData.video_url || interactionsData.video_id;

            if (loadedData && loadedData.video_url) {
                videoUrl = loadedData.video_url;
            } else if (!videoUrlParamProvided) {
                videoUrl = interactionsData.video_url;
            }

            questions = interactionsData.questions || [];
            calculateTotalPoints();
            
            if (videoUrl) {
                initializeVideoPlayer(videoUrl);
            } else {
                showSplashError('Error Crítico', 'No se ha especificado una URL de video. Agrega ?video=URL_DEL_VIDEO.mp4');
            }
        }
        
        function calculateTotalPoints() {
            totalPossiblePoints = 0;
            if (!questions) return;
            
            questions.forEach(interaction => {
                const type = interaction.type;
                if (type === 'true_false' || type === 'multiple_choice') {
                    totalPossiblePoints += (interaction.points || 1);
                } else if (type === 'matching' && interaction.content.correct_matches) {
                    totalPossiblePoints += (interaction.content.correct_matches.length * (interaction.points || 1));
                }
            });
            console.log('Total de puntos posibles calculado:', totalPossiblePoints);
        }
        
        // --- Lógica de la Línea de Tiempo ---

        function createInteractiveMarkers() {
            const markersContainer = document.getElementById('markers-container');
            if (!markersContainer) return;
            if (!questions || questions.length === 0) return;
            
            const existingMarkers = markersContainer.querySelectorAll('.marker');
            existingMarkers.forEach(marker => marker.remove());
            const duration = videoDuration || 180;

            questions.forEach((question, index) => {
                const marker = document.createElement('div');
                marker.className = 'marker';
                const positionPercent = (question.time / duration) * 100;
                marker.style.left = `${positionPercent}%`;
                marker.dataset.interactionIndex = index;
                marker.dataset.time = question.time;
                marker.addEventListener('click', () => jumpToInteraction(index));
                
                const tooltip = document.createElement('div');
                tooltip.className = 'marker-tooltip';
                tooltip.textContent = `Actividad ${index + 1} - ${formatTime(question.time)}`;
                marker.appendChild(tooltip);
                markersContainer.appendChild(marker);
            });
            setupTimelineSlider();
        }

        let timelineSliderSetup = false;
        function setupTimelineSlider() {
            if (timelineSliderSetup) return;
            const markersContainer = document.getElementById('markers-container');
            const timelineHandle = document.getElementById('timeline-handle');
            const timelineTooltip = document.getElementById('timeline-tooltip');
            if (!markersContainer || !timelineHandle || !timelineTooltip) return;
            
            let wasPlaying = false;
            timelineHandle.addEventListener('mousedown', startDrag);
            markersContainer.addEventListener('click', handleTimelineClick);
            markersContainer.addEventListener('mousemove', showTimelineTooltip);
            markersContainer.addEventListener('mouseleave', hideTimelineTooltip);
            timelineSliderSetup = true;

            function startDrag(e) {
                isDragging = true;
                wasPlaying = isPlaying;
                if (isPlaying) pauseVideo();
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                e.preventDefault();
            }
            function drag(e) {
                if (!isDragging || !videoReady) return;
                const rect = markersContainer.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const percentage = x / rect.width;
                const duration = videoElement.duration;
                const newTime = percentage * duration;
                updateTimelineHandle(percentage);
                videoElement.currentTime = newTime;
                timelineTooltip.textContent = formatTime(newTime);
                timelineTooltip.style.left = `${x}px`;
                timelineTooltip.style.opacity = '1';
            }
            function stopDrag() {
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                if (wasPlaying) setTimeout(() => playVideo(), 100);
                hideTimelineTooltip();
            }
            function handleTimelineClick(e) {
                if (isDragging || !videoReady) return;
                if (e.target.classList.contains('marker') || e.target.closest('.marker')) return;
                const rect = markersContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = x / rect.width;
                const duration = videoElement.duration;
                const newTime = percentage * duration;
                const wasPlayingBefore = isPlaying;
                if (isPlaying) pauseVideo();
                videoElement.currentTime = newTime;
                if (wasPlayingBefore) setTimeout(() => playVideo(), 200);
            }
            function showTimelineTooltip(e) {
                if (isDragging) return;
                const rect = markersContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = x / rect.width;
                const duration = videoDuration || 180;
                const time = percentage * duration;
                timelineTooltip.textContent = formatTime(time);
                timelineTooltip.style.left = `${x}px`;
                timelineTooltip.style.opacity = '1';
            }
            function hideTimelineTooltip() {
                if (!isDragging) timelineTooltip.style.opacity = '0';
            }
        }

        function updateTimelineHandle(percentage) {
            const timelineHandle = document.getElementById('timeline-handle');
            if (timelineHandle) timelineHandle.style.left = `${Math.min(Math.max(percentage * 100, 0), 100)}%`;
        }

        function jumpToInteraction(index) {
            if (!videoReady || !videoElement) return;
            const interaction = questions[index];
            console.log(`Saltando a interacción ${index + 1} en tiempo ${interaction.time}s`);
            
            if (interaction.answered) {
                videoElement.currentTime = interaction.time;
                return;
            }
            const seekTime = Math.max(0, interaction.time - 3);
            videoElement.currentTime = seekTime;
            interaction.shown = false;
            setTimeout(() => playVideo(), 500);
        }
        
        // --- Controles de Video (Play, Pausa, Tiempo) ---

        function togglePlayPause() {
            if (document.getElementById('play-pause-btn').disabled || !videoReady) {
                console.log('TogglePlayPause: Video no está listo.');
                return;
            }
            
            try {
                if (videoElement.paused || videoElement.ended) {
                    videoElement.play();
                } else {
                    videoElement.pause();
                }
            } catch (error) { console.error('Error toggling play/pause:', error); }
        }

        function playVideo() {
            if (videoReady && videoElement) try { videoElement.play(); } catch (e) {}
        }

        function pauseVideo() {
            if (videoReady && videoElement) try { videoElement.pause(); } catch (e) {}
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay() {
            if (!videoReady || !videoElement) return;
            try {
                const current = videoElement.currentTime;
                const duration = videoElement.duration;
                document.getElementById('current-time').textContent = formatTime(current);
                document.getElementById('total-time').textContent = formatTime(duration);
            } catch (error) {}
        }

        function updateTimelineProgress() {
            if (!videoReady || !videoElement) return;
            try {
                const duration = videoElement.duration;
                const current = videoElement.currentTime;
                if (duration > 0) {
                    const progress = (current / duration) * 100;
                    const progressPercentage = Math.min(Math.max(progress, 0), 100);
                    const timelineProgress = document.getElementById('timeline-progress');
                    if (timelineProgress) timelineProgress.style.width = `${progressPercentage}%`;
                    updateTimelineHandle(progressPercentage / 100);
                    updateMarkerStates(current);
                    if (!videoDuration) {
                        videoDuration = duration;
                        createInteractiveMarkers();
                    }
                }
            } catch (error) {}
        }

        function updateMarkerStates(currentTime) {
            const markers = document.querySelectorAll('.marker');
            markers.forEach((marker, index) => {
                const interactionTime = parseInt(marker.dataset.time);
                const interactionIndex = parseInt(marker.dataset.interactionIndex);
                if (!questions || !questions[interactionIndex]) return; 
                const interaction = questions[interactionIndex];
                marker.classList.remove('approaching', 'active', 'completed');
                if (interaction && interaction.answered) marker.classList.add('completed');
                else if (Math.abs(currentTime - interactionTime) <= 1) marker.classList.add('active');
                else if (currentTime >= interactionTime - 10 && currentTime < interactionTime) marker.classList.add('approaching');
            });
        }
        
        // --- LÓGICA CENTRAL DE INTERACCIÓN ---

        function showInteraction(index) {
            pauseVideo();
            isInteractionActive = true; 
            
            document.getElementById('video-state-overlay').classList.remove('visible');
            
            currentInteractionIndex = index;
            const interaction = questions[index];
            selectedAnswer = null;
            userMatches = [];
            selectedColumnA = null;
            
            document.getElementById('info-overlay').style.display = 'none';
            document.getElementById('question-overlay').style.display = 'none';
            document.getElementById('feedback-overlay').style.display = 'none';

            switch (interaction.type) {
                case 'text_media':
                    showTextMedia(interaction);
                    break;
                case 'true_false':
                    showTrueFalse(interaction);
                    break;
                case 'multiple_choice':
                    showMultipleChoice(interaction);
                    break;
                case 'matching':
                    showMatching(interaction);
                    break;
                default:
                    console.warn('Tipo de interacción desconocido:', interaction.type);
                    continueVideo();
            }
        }
        
        function showTextMedia(interaction) {
            const content = interaction.content;
            document.getElementById('info-title').textContent = content.title || '';
            const infoContent = document.getElementById('info-content');
            infoContent.innerHTML = '';
            
            if (content.image) {
                const img = document.createElement('img');
                img.src = content.image;
                img.className = 'interaction-image';
                infoContent.appendChild(img);
            }
            if (content.text) {
                const p = document.createElement('p');
                p.className = 'interaction-text';
                p.innerHTML = content.text;
                infoContent.appendChild(p);
            }
            
            document.getElementById('info-overlay').style.display = 'flex';
        }
        
        function showTrueFalse(interaction) {
            const content = interaction.content;
            const interactionContent = document.getElementById('interaction-content');
            interactionContent.innerHTML = '';
            
            updateQuestionCounter();
            
            const title = document.createElement('div');
            title.className = 'interaction-title';
            title.textContent = content.question;
            interactionContent.appendChild(title);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            const trueBtn = document.createElement('button');
            trueBtn.className = 'option-button';
            trueBtn.innerHTML = '<span class="material-icons">check_circle_outline</span> Verdadero';
            trueBtn.addEventListener('click', () => selectOption(true, trueBtn));
            optionsContainer.appendChild(trueBtn);
            
            const falseBtn = document.createElement('button');
            falseBtn.className = 'option-button';
            falseBtn.innerHTML = '<span class="material-icons">highlight_off</span> Falso';
            falseBtn.addEventListener('click', () => selectOption(false, falseBtn));
            optionsContainer.appendChild(falseBtn);
            
            interactionContent.appendChild(optionsContainer);
            
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('question-overlay').style.display = 'flex';
        }
        
        function showMultipleChoice(interaction) {
            const content = interaction.content;
            const interactionContent = document.getElementById('interaction-content');
            interactionContent.innerHTML = '';
            
            updateQuestionCounter();
            
            const title = document.createElement('div');
            title.className = 'interaction-title';
            title.textContent = content.question;
            interactionContent.appendChild(title);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            content.options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = `${String.fromCharCode(65 + index)}. ${optionText}`;
                button.addEventListener('click', () => selectOption(index, button));
                optionsContainer.appendChild(button);
            });
            
            interactionContent.appendChild(optionsContainer);
            
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('question-overlay').style.display = 'flex';
        }
        
        function showMatching(interaction) {
            const content = interaction.content;
            userMatches = [];
            selectedColumnA = null;
            
            const interactionContent = document.getElementById('interaction-content');
            interactionContent.innerHTML = '';
            
            updateQuestionCounter();
            
            const title = document.createElement('div');
            title.className = 'interaction-title';
            title.textContent = content.question;
            interactionContent.appendChild(title);
            
            const matchingContainer = document.createElement('div');
            matchingContainer.className = 'matching-container';
            
            const colA = document.createElement('div');
            colA.className = 'matching-column';
            colA.id = 'column-a';
            
            const colB = document.createElement('div');
            colB.className = 'matching-column';
            colB.id = 'column-b';
            
            const headerA = document.createElement('div');
            headerA.className = 'matching-column-header';
            headerA.textContent = 'Columna A';
            colA.appendChild(headerA);
            
            const headerB = document.createElement('div');
            headerB.className = 'matching-column-header';
            headerB.textContent = 'Columna B';
            colB.appendChild(headerB);
            
            const shuffledA = shuffleArray([...content.column_a]);
            const shuffledB = shuffleArray([...content.column_b]);

            shuffledA.forEach((itemText, shuffledIndex) => {
                const originalIndex = content.column_a.indexOf(itemText);
                const item = document.createElement('div');
                item.className = 'column-item';
                item.textContent = itemText;
                item.dataset.index = originalIndex;
                item.dataset.number = shuffledIndex + 1;
                item.addEventListener('click', () => selectMatchingColumnA(item, originalIndex));
                colA.appendChild(item);
            });
            
            shuffledB.forEach((itemText, shuffledIndex) => {
                const originalIndex = content.column_b.indexOf(itemText);
                const item = document.createElement('div');
                item.className = 'column-item';
                item.textContent = itemText;
                item.dataset.index = originalIndex;
                item.dataset.number = shuffledIndex + 1;
                item.addEventListener('click', () => selectMatchingColumnB(item, originalIndex));
                colB.appendChild(item);
            });
            
            matchingContainer.appendChild(colA);
            matchingContainer.appendChild(colB);
            interactionContent.appendChild(matchingContainer);
            
            const instructions = document.createElement('div');
            instructions.style.cssText = 'font-size: 14px; color: #666; margin-top: 16px; font-style: italic;';
            instructions.textContent = 'Haz clic en un elemento de la Columna A y luego en su correspondiente en la Columna B.';
            interactionContent.appendChild(instructions);
            
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('question-overlay').style.display = 'flex';
        }
        
        function selectOption(index, button) {
            document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedAnswer = index;
            document.getElementById('submit-btn').disabled = false;
        }
        
        function selectMatchingColumnA(item, indexA) {
            if (selectedColumnA && selectedColumnA.index === indexA) {
                selectedColumnA.element.classList.remove('selected');
                selectedColumnA = null;
            } else {
                document.querySelectorAll('#column-a .column-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                selectedColumnA = { element: item, index: indexA };
            }
        }
        
        function selectMatchingColumnB(item, indexB) {
            if (!selectedColumnA) return;
            
            const indexA = selectedColumnA.index;
            
            userMatches = userMatches.filter(match => match.a_index !== indexA && match.b_index !== indexB);
            
            document.querySelectorAll(`.paired-a-${indexA}, .paired-b-${indexB}`).forEach(el => {
                el.classList.remove('paired-a', 'paired-b', `paired-a-${indexA}`, `paired-b-${indexB}`);
            });
            
            userMatches.push({ a_index: indexA, b_index: indexB });
            
            selectedColumnA.element.classList.add('paired-a', `paired-a-${indexA}`);
            item.classList.add('paired-b', `paired-b-${indexB}`);
            
            selectedColumnA.element.classList.remove('selected');
            selectedColumnA = null;
            
            if (userMatches.length === questions[currentInteractionIndex].content.column_a.length) {
                document.getElementById('submit-btn').disabled = false;
            }
        }

        function submitAnswer() {
            const interaction = questions[currentInteractionIndex];
            
            document.getElementById('submit-btn').disabled = true;
            
            interaction.answered = true;
            questionsAnswered++;
            
            let isCorrect = false;
            
            switch (interaction.type) {
                case 'true_false':
                case 'multiple_choice':
                    isCorrect = (selectedAnswer === interaction.content.correct_answer);
                    if (isCorrect) userScore += (interaction.points || 1);
                    highlightChoiceAnswers(isCorrect, interaction.content.correct_answer);
                    break;
                case 'matching':
                    const correctPairs = checkMatchingAnswers(interaction.content.correct_matches);
                    userScore += (correctPairs * (interaction.points || 1));
                    isCorrect = (correctPairs === interaction.content.correct_matches.length);
                    highlightMatchingAnswers(isCorrect, interaction.content.correct_matches);
                    break;
            }
            
            interaction.correct = isCorrect;
            
            try { createAudioFeedback(isCorrect ? 'correct' : 'incorrect'); } catch (e) {}
            
            setTimeout(() => {
                showFeedback(isCorrect, interaction.content.feedback);
            }, 1500);
            
            updateProgress();
        }
        
        function highlightChoiceAnswers(isCorrect, correctIndex) {
            document.querySelectorAll('.option-button').forEach((btn, index) => {
                if (index === correctIndex) {
                    btn.classList.add('correct');
                } else if (index === selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
                btn.onclick = null;
            });
        }
        
        function checkMatchingAnswers(correctMatches) {
            let correctCount = 0;
            userMatches.forEach(userMatch => {
                const isPairCorrect = correctMatches.some(cm => 
                    cm.a_index === userMatch.a_index && cm.b_index === userMatch.b_index
                );
                if (isPairCorrect) {
                    correctCount++;
                }
            });
            return correctCount;
        }
        
        function highlightMatchingAnswers(isCorrect, correctMatches) {
            document.querySelectorAll('.column-item').forEach(el => el.onclick = null);

            if (isCorrect) {
                 document.querySelectorAll('.column-item').forEach(el => el.classList.add('correct'));
                 return;
            }
            
            userMatches.forEach(userMatch => {
                const isPairCorrect = correctMatches.some(cm => 
                    cm.a_index === userMatch.a_index && cm.b_index === userMatch.b_index
                );
                
                const elA = document.querySelector(`#column-a .column-item[data-index="${userMatch.a_index}"]`);
                const elB = document.querySelector(`#column-b .column-item[data-index="${userMatch.b_index}"]`);
                
                if (isPairCorrect) {
                    elA.classList.add('correct');
                    elB.classList.add('correct');
                } else {
                    elA.classList.add('incorrect');
                    elB.classList.add('incorrect');
                }
            });
        }

        function showFeedback(isCorrect, feedback) {
            document.getElementById('question-overlay').style.display = 'none';
            document.getElementById('info-overlay').style.display = 'none';
            
            const feedbackCard = document.getElementById('feedback-card');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackMessage = document.getElementById('feedback-message');
            
            if (isCorrect) {
                feedbackCard.className = 'feedback-card correct';
                feedbackIcon.innerHTML = '<span class="material-icons">check_circle</span>';
                feedbackIcon.className = 'feedback-icon correct';
                feedbackTitle.textContent = '¡Correcto!';
                feedbackMessage.textContent = feedback.correct;
            } else {
                feedbackCard.className = 'feedback-card incorrect';
                feedbackIcon.innerHTML = '<span class="material-icons">cancel</span>';
                feedbackIcon.className = 'feedback-icon incorrect';
                feedbackTitle.textContent = 'Incorrecto';
                feedbackMessage.textContent = feedback.incorrect;
            }
            
            document.getElementById('feedback-overlay').style.display = 'flex';
        }

        function continueVideo() {
            document.getElementById('feedback-overlay').style.display = 'none';
            document.getElementById('info-overlay').style.display = 'none';
            document.getElementById('question-overlay').style.display = 'none';
            
            isInteractionActive = false;
            
            const markers = document.querySelectorAll('.marker');
            if (markers[currentInteractionIndex]) {
                markers[currentInteractionIndex].classList.add('completed');
            }
            
            playVideo();
        }

        function updateProgress() {
            if (!questions || questions.length === 0) return;
            
            const respondibleQuestions = questions.filter(q => q.type !== 'text_media').length;
            const answeredRespondible = questions.filter(q => q.answered && q.type !== 'text_media').length;
            
            const progress = (answeredRespondible / respondibleQuestions) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }
        
        function updateQuestionCounter() {
            const num = currentInteractionIndex + 1;
            const total = questions.length;
            document.getElementById('question-counter').innerHTML = `
                <span class="material-icons">help_outline</span>
                Actividad ${num} de ${total}
            `;
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Controles de Video Adicionales ---

        function restartVideo() {
            if (!videoReady || !videoElement) return;
            try {
                if (questions) {
                    questions.forEach(q => {
                        q.shown = false;
                        q.answered = false;
                        q.correct = false;
                    });
                }
                questionsAnswered = 0;
                userScore = 0; 
                currentInteractionIndex = 0;
                currentVideoTime = 0;
                isInteractionActive = false;
                hasAttemptedFallback = false;
                
                videoElement.currentTime = 0;
                videoElement.pause();
                isPlaying = false;
                document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">play_arrow</span>';
                
                document.getElementById('question-overlay').style.display = 'none';
                document.getElementById('feedback-overlay').style.display = 'none';
                document.getElementById('info-overlay').style.display = 'none';
                document.getElementById('results-overlay').style.display = 'none';
                
                const stateOverlay = document.getElementById('video-state-overlay');
                const titleEl = stateOverlay.querySelector('.splash-title');
                const subtitleEl = stateOverlay.querySelector('.splash-subtitle');
                const playButton = stateOverlay.querySelector('.splash-play-button');
                
                titleEl.textContent = 'Video Interactivo';
                titleEl.style.color = 'white';
                subtitleEl.textContent = 'Presiona para iniciar';
                playButton.style.display = 'flex';
                stateOverlay.classList.remove('error');
                
                stateOverlay.classList.add('visible');
                
                document.querySelectorAll('.marker').forEach(marker => {
                    marker.classList.remove('completed', 'approaching', 'active');
                });
                
                updateTimelineHandle(0);
                setTimeout(() => {
                    updateTimelineProgress();
                    updateTimeDisplay();
                }, 200);
                
                updateProgress();
                showNotification('Video reiniciado');
                
                if (videoUrl) {
                    initializeVideoPlayer(videoUrl);
                }
                
            } catch (error) { console.error('Error restarting video:', error); }
        }

        function toggleAudio() {
            if (!videoReady || !videoElement) return;
            isMuted = !isMuted;
            videoElement.muted = isMuted;
            const audioBtn = document.getElementById('audio-btn');
            if (isMuted) {
                audioBtn.innerHTML = '<span class="material-icons">volume_off</span>';
                audioBtn.title = 'Activar audio';
                showNotification('Audio silenciado');
            } else {
                audioBtn.innerHTML = '<span class="material-icons">volume_up</span>';
                audioBtn.title = 'Silenciar audio';
                showNotification('Audio activado');
            }
        }

        function toggleFullscreen() {
            const container = document.querySelector('.container');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(() => {
                    showNotification('No se pudo activar pantalla completa');
                });
            } else {
                document.exitFullscreen();
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: rgba(0,0,0,0.8); color: white;
                padding: 12px 20px; border-radius: 4px;
                font-size: 14px; z-index: 2000;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function showResults() {
            if (!questions || totalPossiblePoints === 0) {
                showNotification("No hay actividades puntuables en este video.");
                return;
            }
            
            pauseVideo();
            isInteractionActive = true; 

            document.getElementById('video-state-overlay').classList.remove('visible');

            const percentage = Math.round((userScore / totalPossiblePoints) * 100);
            
            const resultsOverlay = document.getElementById('results-overlay');
            const resultsIcon = document.getElementById('results-icon');
            const resultsTitle = document.getElementById('results-title');
            const resultsMessage = document.getElementById('results-message');
            const resultsDetails = document.getElementById('results-details');
            const resultsPercentage = document.getElementById('results-percentage');
            const resultsScoreRing = document.getElementById('results-score-ring');
            
            resultsDetails.textContent = `Puntos: ${userScore} / ${totalPossiblePoints}`;
            resultsPercentage.textContent = `${percentage}%`;

            resultsIcon.className = 'results-icon';
            resultsScoreRing.classList.remove('animate');
            
            let message = '';
            let title = '';
            let icon = '';
            let sound = '';
            let ringColor = '#ff9500';

            if (percentage >= 90) {
                title = '¡Excelente!';
                message = '¡Felicidades! Has dominado este contenido.';
                icon = 'emoji_events';
                resultsIcon.classList.add('excellent');
                sound = 'results_excellent';
                ringColor = '#28a745';
            } else if (percentage >= 85) {
                title = '¡Buen Trabajo!';
                message = 'Has entendido la mayor parte del material. ¡Sigue así!';
                icon = 'thumb_up';
                resultsIcon.classList.add('good');
                sound = 'results_good';
                ringColor = '#1768ac';
            } else {
                title = '¡Puedes Mejorar!';
                message = 'No te preocupes. Revisa el video e inténtalo de nuevo.';
                icon = 'replay';
                resultsIcon.classList.add('improve');
                sound = 'results_bad';
                ringColor = '#ff9500';
            }
            
            resultsTitle.textContent = title;
            resultsMessage.textContent = message;
            resultsIcon.querySelector('.material-icons').textContent = icon;
            
            try { createAudioFeedback(sound); } catch(e) {}

            resultsOverlay.style.display = 'flex';
            
            void resultsScoreRing.offsetWidth;
            
            resultsScoreRing.style.setProperty('--ring-percentage', `${percentage * 3.6}deg`);
            resultsScoreRing.style.setProperty('--ring-color', ringColor);
            resultsScoreRing.classList.add('animate');
        }
        
        function showSplashError(title, message) {
            const stateOverlay = document.getElementById('video-state-overlay');
            const titleEl = stateOverlay.querySelector('.splash-title');
            const subtitleEl = stateOverlay.querySelector('.splash-subtitle');
            const playButton = stateOverlay.querySelector('.splash-play-button');
            
            titleEl.textContent = title;
            titleEl.style.color = '#dc3545';
            subtitleEl.textContent = message;
            
            playButton.style.display = 'none';
            
            stateOverlay.classList.add('visible', 'error');
            stateOverlay.style.cursor = 'default';
            
            const blocker = document.getElementById('video-overlay-blocker');
            if (blocker) blocker.style.display = 'none';
        }

        function updateSplashLoading(isLoading, message = "Presiona para iniciar") {
            const stateOverlay = document.getElementById('video-state-overlay');
            const subtitleEl = stateOverlay.querySelector('.splash-subtitle');
            const playButton = stateOverlay.querySelector('.splash-play-button');

            subtitleEl.textContent = message;
            if (isLoading) {
                stateOverlay.classList.add('loading');
                stateOverlay.style.cursor = 'default';
            } else {
                stateOverlay.classList.remove('loading');
                stateOverlay.style.cursor = 'pointer';
            }
        }

        // --- SDK de Elementos ---
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange: async (config) => {
                    const descEl = document.getElementById('video-description');
                    if (descEl) descEl.textContent = config.video_description || defaultConfig.video_description;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["video_description", config.video_description || defaultConfig.video_description]
                ])
            });
        }
    </script>
</body>
</html>