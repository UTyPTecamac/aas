<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Interactivo H5P</title>
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100%;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .header {
            background: #1768ac;
            color: white;
            padding: 20px 24px;
            text-align: left;
            border-bottom: 3px solid #0f5c9c;
        }

        .header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 600;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .video-container {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
        }

        .video-player {
            width: 100%;
            height: 100%;
            border: none;
        }

        .question-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .question-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 80%;
            height: 80%;
            max-width: 1000px;
            max-height: 800px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: none;
            animation: slideIn 0.4s ease-out;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(5px);
        }

        .feedback-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            height: auto;
            max-width: 500px;
            max-height: 70%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            border: none;
            animation: bounceIn 0.6s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
        }

        .feedback-card.correct {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 3px solid #28a745;
        }

        .feedback-card.incorrect {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 3px solid #dc3545;
        }

        .feedback-icon {
            font-size: 0;
            margin-bottom: 30px;
            animation: iconPulse 0.8s ease-out;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .feedback-icon .material-icons {
            font-size: 150px;
            line-height: 1;
        }

        .feedback-icon.correct {
            color: #ffffff;
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .feedback-icon.incorrect {
            color: #ffffff;
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #e2e8f0;
            border-top: 6px solid #1768ac;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* NUEVO: Estilo para spinner de error */
        .loading-spinner.error {
            border-top-color: #dc3545;
            animation: none; /* Detener giro */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc3545;
            font-size: 40px;
            font-weight: bold;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* NUEVO: Estilo para texto de error */
        .loading-text.error {
            color: #dc3545;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: #4a5568;
        }

        .feedback-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .feedback-message {
            font-size: 18px;
            line-height: 1.5;
            margin-bottom: 24px;
            color: #4a5568;
            max-width: 400px;
        }

        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .question-icon {
            font-size: 48px;
            color: #1768ac;
            margin-right: 16px;
        }

        .question-info {
            flex: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes iconPulse {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            30% {
                transform: scale(1.3) rotate(-90deg);
                opacity: 0.7;
            }
            60% {
                transform: scale(0.9) rotate(0deg);
                opacity: 0.9;
            }
            80% {
                transform: scale(1.1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .question-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .question-title {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 32px;
            flex: 1;
        }

        .option-button {
            background: #ffffff;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px 24px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            color: #2d3748;
            position: relative;
            display: flex;
            align-items: center;
            min-height: 60px;
        }

        .option-button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .option-button.selected {
            background: #ebf8ff;
            border-color: #1768ac;
            color: #1768ac;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23,104,172,0.2);
        }

        .option-button.correct {
            background: #f0fff4;
            border-color: #28a745;
            color: #22543d;
            animation: correctAnswer 0.6s ease-out;
        }

        .option-button.correct::before {
            content: '✓';
            color: #28a745;
            font-weight: bold;
            font-size: 24px;
            margin-right: 12px;
        }

        .option-button.incorrect {
            background: #fff5f5;
            border-color: #dc3545;
            color: #742a2a;
            animation: incorrectAnswer 0.6s ease-out;
        }

        .option-button.incorrect::before {
            content: '✗';
            color: #dc3545;
            font-weight: bold;
            font-size: 24px;
            margin-right: 12px;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #c6f6d5; }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .question-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 2px solid #e2e8f0;
        }

        .submit-btn, .continue-btn {
            background: #1768ac;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 160px;
            justify-content: center;
        }

        .submit-btn:hover, .continue-btn:hover {
            background: #0f5c9c;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23,104,172,0.3);
        }

        .submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            color: #a0aec0;
            transform: none;
            box-shadow: none;
        }

        .continue-btn {
            background: #28a745;
            font-size: 18px;
            padding: 16px 32px;
            border-radius: 12px;
        }

        .continue-btn:hover {
            background: #218838;
            box-shadow: 0 8px 25px rgba(40,167,69,0.3);
        }

        .question-counter {
            color: #4a5568;
            font-size: 16px;
            font-weight: 600;
            background: #f7fafc;
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar {
            background: #e6e6e6;
            height: 6px;
            border-radius: 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: #1768ac;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: #0f5c9c;
        }

        .controls {
            padding: 16px 24px;
            background: #000000;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .play-pause-btn {
            background: #1768ac;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .play-pause-btn:hover {
            background: #0f5c9c;
        }
        
        .play-pause-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .play-pause-btn:disabled:hover {
            background: #cbd5e0;
        }

        .time-display {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-left: 12px;
            font-family: 'Courier New', monospace;
            min-width: 100px;
        }

        .time-display span {
            color: #ffffff;
        }

        .interactive-markers {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            margin: 0 16px;
        }

        .markers-container {
            position: relative;
            flex: 1;
            height: 8px;
            background: #e6e6e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .markers-container:hover {
            height: 12px;
            margin: -2px 0;
        }

        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #1768ac;
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
            pointer-events: none;
        }

        .timeline-handle {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: #1768ac;
            border: 3px solid white;
            border-radius: 50%;
            cursor: grab;
            transform: translateX(-50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            z-index: 5;
        }

        .timeline-handle:hover {
            transform: translateX(-50%) scale(1.2);
            background: #0f5c9c;
        }

        .timeline-handle:active {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.3);
        }

        .marker {
            position: absolute;
            top: -2px;
            width: 12px;
            height: 12px;
            background: #1768ac;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 3;
        }

        .marker:hover {
            transform: scale(1.3);
            background: #0f5c9c;
            z-index: 4;
        }

        .marker.completed {
            background: #5cb85c;
            animation: completedPulse 0.5s ease-out;
        }

        .marker.approaching {
            background: #ff9500;
            animation: approachingPulse 1.5s infinite;
            transform: scale(1.2);
        }

        .marker.active {
            background: #ff4444;
            animation: activePulse 1s infinite;
            transform: scale(1.4);
        }

        @keyframes completedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        @keyframes approachingPulse {
            0%, 100% { 
                transform: scale(1.2);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.4);
                box-shadow: 0 4px 12px rgba(255, 149, 0, 0.6);
            }
        }

        @keyframes activePulse {
            0%, 100% { 
                transform: scale(1.4);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.6);
                box-shadow: 0 6px 16px rgba(255, 68, 68, 0.8);
            }
        }

        .marker-tooltip {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .marker:hover .marker-tooltip {
            opacity: 1;
        }

        .timeline-tooltip {
            position: absolute;
            bottom: 25px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
            transform: translateX(-50%);
        }

        .markers-label {
            font-size: 12px;
            color: #ffffff;
            white-space: nowrap;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: transparent;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: normal;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn:hover {
            border-color: #777;
            background: rgba(255,255,255,0.1);
        }

        .control-btn.icon-only {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        .dropdown-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 120px;
            margin-bottom: 8px;
            display: none;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: #333;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item.active {
            background: #e8f4fd;
            color: #1768ac;
        }

        .control-btn {
            position: relative;
        }

        .feedback {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 4px;
            font-weight: normal;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .feedback.correct {
            background: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }

        .feedback.correct::before {
            content: '✓';
            color: #5cb85c;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .feedback.incorrect {
            background: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }

        .feedback.incorrect::before {
            content: '✗';
            color: #d9534f;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }
            
            .question-card, .feedback-card {
                width: 95%;
                height: 90%;
                padding: 24px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }

            .question-title {
                font-size: 20px;
            }

            .option-button {
                font-size: 16px;
                padding: 16px 20px;
            }

            .feedback-title {
                font-size: 24px;
            }

            .feedback-message {
                font-size: 16px;
            }

            .feedback-icon {
                font-size: 80px;
                margin-bottom: 16px;
            }

            .feedback-card {
                padding: 24px;
                max-height: 80%;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="container">
   <div class="header" style="display: none;">
    <p id="video-description">Responde las preguntas que aparecen durante el video</p>
   </div>
   <div class="progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
   </div>
   <div class="video-container">
    <!-- CORRECCIÓN: Se reemplazó el <iframe> con un <div>. -->
    <!-- El script de la API de YouTube reemplazará este div con el <iframe> del video correcto. -->
    <div id="video-player" class="video-player"></div>
    
    <!-- Pantalla de Pregunta -->
    <div class="question-overlay" id="question-overlay">
     <div class="question-card">
      <div class="question-header">
       <div class="question-icon"><span class="material-icons">quiz</span>
       </div>
       <div class="question-info">
        <div class="question-counter" id="question-counter"><span class="material-icons">help_outline</span> Pregunta 1 de 5
        </div>
       </div><button class="submit-btn" id="submit-btn" disabled> <span class="material-icons">send</span> Responder </button>
      </div><img id="question-image" class="question-image" style="display: none;" alt="Imagen de la pregunta">
      <div class="question-title" id="question-title"></div>
      <div class="options-container" id="options-container"></div>
      <div class="question-actions">
       <div></div>
       <div></div>
      </div>
     </div>
    </div><!-- Pantalla de Retroalimentación -->
    <div class="feedback-overlay" id="feedback-overlay">
     <div class="feedback-card" id="feedback-card">
      <div class="feedback-icon" id="feedback-icon"><span class="material-icons">check_circle</span>
      </div>
      <div class="feedback-title" id="feedback-title">
       ¡Correcto!
      </div>
      <div class="feedback-message" id="feedback-message">
       ¡Excelente! Has respondido correctamente.
      </div><button class="continue-btn" id="continue-btn"> <span class="material-icons">play_arrow</span> Continuar </button>
     </div>
    </div>
   </div>
   <div class="controls">
    <div class="video-controls"><button class="play-pause-btn" id="play-pause-btn"> <span class="material-icons">play_arrow</span> </button>
     <div class="time-display" id="time-display"><span id="current-time">0:00</span> / <span id="total-time">0:00</span>
     </div>
    </div>
    <div class="interactive-markers"><span class="markers-label">Actividades:</span>
     <div class="markers-container" id="markers-container">
      <div class="timeline-progress" id="timeline-progress"></div>
      <div class="timeline-handle" id="timeline-handle"></div>
      <div class="timeline-tooltip" id="timeline-tooltip">
       0:00
      </div>
     </div>
    </div>
    <div class="control-buttons"><button class="control-btn icon-only" id="audio-btn" title="Silenciar/Activar audio"> <span class="material-icons">volume_up</span> </button> <button class="control-btn icon-only" id="fullscreen-btn" title="Pantalla completa"> <span class="material-icons">fullscreen</span> </button> <button class="control-btn icon-only" id="restart-btn" title="Reiniciar video"> <span class="material-icons">replay</span> </button> <button class="control-btn icon-only" id="results-btn" title="Ver resultados"> <span class="material-icons">assessment</span> </button>
    </div>
   </div>
  </div>
  <!-- Overlay de carga -->
  <div class="loading-overlay" id="loading-overlay">
   <div class="loading-content">
    <div class="loading-spinner" id="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Cargando contenido...</div>
    <div class="loading-subtext" id="loading-subtext">Por favor espera</div>
   </div>
  </div>
  <script>
        // Configuración por defecto
        const defaultConfig = {
            video_description: "Responde las preguntas que aparecen durante el video"
        };

        // Datos JSON de las preguntas (Fallback)
        // ESTOS DATOS SÓLO SE USARÁN SI NO SE PROVEE UN JSON EXTERNO
        let questionsData = {
            "video_id": "jCcZfY04at4",
            "questions": [
                {
                    "id": 1,
                    "time": 15,
                    "question": "(EJEMPLO) ¿Cuál es el tema principal que se presenta al inicio del video?",
                    "image": null,
                    "options": [
                        "Introducción a la programación",
                        "Historia de la computación",
                        "Conceptos básicos de algoritmos",
                        "Desarrollo web moderno"
                    ],
                    "correct_answer": 0,
                    "feedback": {
                        "correct": "¡Correcto! El video comienza con una introducción a los conceptos de programación.",
                        "incorrect": "Incorrecto. El video se enfoca en introducir conceptos básicos de programación."
                    }
                },
                {
                    "id": 2,
                    "time": 45,
                    "question": "(EJEMPLO) Según el video, ¿qué es lo más importante al aprender a programar?",
                    "image": null,
                    "options": [
                        "Memorizar sintaxis",
                        "Entender la lógica",
                        "Usar las herramientas más nuevas",
                        "Programar rápidamente"
                    ],
                    "correct_answer": 1,
                    "feedback": {
                        "correct": "¡Excelente! La lógica es fundamental en la programación.",
                        "incorrect": "No es correcto. Lo más importante es desarrollar el pensamiento lógico."
                    }
                }
            ]
        };

        // Variables globales
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let questionsAnswered = 0;
        let correctAnswers = 0;
        let questionsEnabled = true;
        let videoStartTime = 0;
        let isPlaying = false;
        let videoTimer = null;
        let currentVideoTime = 0;
        let videoDuration = 0;
        let currentSpeed = 1;
        let currentQuality = '480p';
        let isMuted = false;
        let player = null;
        let playerReady = false;
        let isDragging = false;
        
        // Configuración del video desde URL
        let videoId = 'jCcZfY04at4'; // Por defecto
        let jsonFile = null; // Se cargará desde URL
        let videoParamProvided = false; // <-- NUEVA VARIABLE: Para dar prioridad al parámetro de URL

        // Función para crear sonidos de retroalimentación
        function createAudioFeedback(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === 'correct') {
                // Sonido de éxito - acordes ascendentes
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1 + (index * 0.1));
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5 + (index * 0.1));
                    
                    oscillator.start(audioContext.currentTime + (index * 0.1));
                    oscillator.stop(audioContext.currentTime + 0.5 + (index * 0.1));
                });
            } else if (type === 'incorrect') {
                // Sonido de error - tono descendente
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.5);
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        // Función para extraer ID de YouTube desde URL o ID
        function extractYouTubeId(urlOrId) {
            if (!urlOrId) return null;
            
            // Si ya es un ID (solo letras, números, guiones y guiones bajos)
            if (/^[a-zA-Z0-9_-]{11}$/.test(urlOrId)) {
                return urlOrId;
            }
            
            // Intentar extraer de diferentes formatos de URL de YouTube
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/.*[?&]v=([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = urlOrId.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Función para obtener parámetros de URL
        // Uso: video_interactivo.html?video=VIDEO_ID_OR_URL&json=URL_JSON
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoParam = urlParams.get('video');
            const jsonParam = urlParams.get('json');
            
            if (videoParam) {
                const extractedId = extractYouTubeId(videoParam);
                if (extractedId) {
                    videoId = extractedId;
                    videoParamProvided = true; // <-- MODIFICACIÓN: Marcar que el video vino de la URL
                } else {
                    console.warn('No se pudo extraer el ID del video de:', videoParam);
                }
            }
            
            if (jsonParam) {
                jsonFile = decodeURIComponent(jsonParam);
            }
        }

        // Variables de control del flujo de inicialización
        let youtubeAPIReady = false;
        let jsonDataLoaded = false;
        let playerInitialized = false;
        let initializationInProgress = false;

        // Función requerida por YouTube API
        function onYouTubeIframeAPIReady() {
            youtubeAPIReady = true;
            tryInitializePlayer();
        }
        
        // Función para intentar inicializar el player
        function tryInitializePlayer() {
            if (initializationInProgress || playerInitialized) {
                return;
            }
            
            // PASO 1: Verificar que el JSON/Datos estén listos
            if (!jsonDataLoaded) {
                 // console.log('Esperando JSON...');
                return;
            }
            
            // PASO 2: Verificar que la API de YouTube esté lista
            if (!youtubeAPIReady) {
                // console.log('Esperando API de YouTube...');
                return;
            }
            
            // PASO 3: Verificar que tengamos un videoId
            if (!videoId) {
                console.warn('No hay videoId disponible');
                showError('Error Crítico', 'No se ha especificado un ID de video válido.');
                return;
            }
            
            // PASO 4: Inicializar el player
            initializationInProgress = true;
            
            try {
                player = new YT.Player('video-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'controls': 0,
                        'rel': 0,
                        'autoplay': 0,
                        'mute': 0,
                        'enablejsapi': 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
                
                playerInitialized = true;
                initializationInProgress = false;
            } catch (error) {
                console.error('Error al inicializar el player:', error);
                showError('Error de Player', 'No se pudo iniciar el reproductor de YouTube.');
                initializationInProgress = false;
            }
        }

        function onPlayerReady(event) {
            playerReady = true;
            
            setTimeout(() => {
                try {
                    videoDuration = player.getDuration();
                    updateTimeDisplay();
                    createInteractiveMarkers();
                } catch (error) {
                    console.warn('No se pudo obtener la duración, usando 180s por defecto.', error);
                    videoDuration = 180; // Duración por defecto
                    createInteractiveMarkers();
                }
                
                // Ocultar loading cuando todo esté listo
                hideLoading();
            }, 1000);
            
            setupEventListeners();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">pause</span>';
                startVideoTimer();
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
                document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">play_arrow</span>';
                if (videoTimer) {
                    clearInterval(videoTimer);
                    videoTimer = null;
                }
            } else if (event.data == YT.PlayerState.ENDED) {
                isPlaying = false;
                document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">replay</span>';
                if (videoTimer) {
                    clearInterval(videoTimer);
                    videoTimer = null;
                }
            } else if (event.data == YT.PlayerState.CUED || event.data == -1) {
                isPlaying = false;
                document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">play_arrow</span>';
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('audio-btn').addEventListener('click', toggleAudio);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            document.getElementById('restart-btn').addEventListener('click', restartVideo);
            document.getElementById('results-btn').addEventListener('click', showResults);
            
            const submitBtn = document.getElementById('submit-btn');
            const continueBtn = document.getElementById('continue-btn');
            
            if (submitBtn) submitBtn.addEventListener('click', submitAnswer);
            if (continueBtn) continueBtn.addEventListener('click', continueVideo);
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            const playBtn = document.getElementById('play-pause-btn');
            if (playBtn) playBtn.disabled = true;
            
            getUrlParams();
            
            // Cargar datos (externos o por defecto)
            await loadQuestionsData();
            
            // tryInitializePlayer() es llamado desde loadQuestionsData() y onYouTubeIframeAPIReady()
            
            updateProgress();
            setupBasicEventListeners();
        });
        
        // Event listeners básicos que no dependen del reproductor
        function setupBasicEventListeners() {
            const restartBtn = document.getElementById('restart-btn');
            const resultsBtn = document.getElementById('results-btn');
            
            if (restartBtn && !restartBtn.hasAttribute('data-listener')) {
                restartBtn.addEventListener('click', restartVideo);
                restartBtn.setAttribute('data-listener', 'true');
            }
            
            if (resultsBtn && !resultsBtn.hasAttribute('data-listener')) {
                resultsBtn.addEventListener('click', showResults);
                resultsBtn.setAttribute('data-listener', 'true');
            }
        }

        // Funciones para mostrar/ocultar loading
        function showLoading(text, subtext) {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingSubtext = document.getElementById('loading-subtext');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            if (overlay) {
                loadingText.textContent = text || 'Cargando contenido...';
                loadingSubtext.textContent = subtext || 'Por favor espera';
                loadingText.classList.remove('error');
                loadingSpinner.classList.remove('error');
                loadingSpinner.innerHTML = ''; // Limpiar ícono de error
                overlay.style.display = 'flex';
            }
            
            const playBtn = document.getElementById('play-pause-btn');
            if (playBtn) {
                playBtn.disabled = true;
                playBtn.style.opacity = '0.5';
                playBtn.style.cursor = 'not-allowed';
            }
        }
        
        // NUEVA: Función para mostrar error en pantalla de carga
        function showError(text, subtext) {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingSubtext = document.getElementById('loading-subtext');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            if (overlay) {
                loadingText.textContent = text || 'Error';
                loadingSubtext.textContent = subtext || 'No se pudo cargar el contenido';
                loadingText.classList.add('error');
                loadingSpinner.classList.add('error');
                loadingSpinner.innerHTML = 'X'; // Ícono de error
                overlay.style.display = 'flex';
            }
            
            const playBtn = document.getElementById('play-pause-btn');
            if (playBtn) {
                playBtn.disabled = true;
                playBtn.style.opacity = '0.5';
                playBtn.style.cursor = 'not-allowed';
            }
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            const playBtn = document.getElementById('play-pause-btn');
            if (playBtn) {
                playBtn.disabled = false;
                playBtn.style.opacity = '1';
                playBtn.style.cursor = 'pointer';
            }
        }

        // Función para cargar datos de preguntas con reintentos
        async function loadQuestionsData() {
            showLoading('Cargando preguntas...', 'Conectando con el servidor');
            
            if (jsonFile) {
                // Hay un JSON externo especificado
                const maxRetries = 3;
                let retryCount = 0;
                let success = false;
                let lastError = null;
                
                while (retryCount < maxRetries && !success) {
                    try {
                        showLoading('Cargando preguntas...', retryCount > 0 ? `Reintento ${retryCount + 1} de ${maxRetries}` : 'Conectando con el servidor');
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // Timeout de 10 segundos
                        
                        const response = await fetch(jsonFile, {
                            signal: controller.signal,
                            cache: 'no-cache'
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (!data || (!data.questions && !data.video_id)) {
                                throw new Error('JSON inválido: estructura incorrecta');
                            }
                            
                            // MODIFICACIÓN: El video de la URL tiene prioridad.
                            // Solo usar el video_id del JSON si NO se proveyó un parámetro 'video' en la URL.
                            if (data.video_id && !videoParamProvided) {
                                const extractedId = extractYouTubeId(data.video_id);
                                if (extractedId) videoId = extractedId;
                            }
                            
                            if (data.questions && Array.isArray(data.questions)) {
                                if (data.questions.length === 0) {
                                    throw new Error('JSON no contiene preguntas');
                                }
                                // REEMPLAZAR los datos de ejemplo por los del JSON
                                questionsData = data;
                                if (!questionsData.video_id) questionsData.video_id = videoId;
                            } else {
                                throw new Error('JSON no contiene un array de "questions"');
                            }
                            
                            success = true;
                            showLoading('Preguntas cargadas', 'Inicializando video...');
                        } else {
                            throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                        }
                    } catch (error) {
                        retryCount++;
                        lastError = error;
                        console.error(`Error cargando JSON (intento ${retryCount}/${maxRetries}):`, error);
                        
                        if (retryCount < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        }
                    }
                }

                // FIN DEL BUCLE DE REINTENTOS
                if (!success) {
                    console.error('FALLO DEFINITIVO: No se pudo cargar el JSON después de', maxRetries, 'intentos.');
                    // MODIFICACIÓN: Mostrar error al usuario en lugar de usar datos de ejemplo
                    showError('Error de Carga', 'No se pudo cargar el archivo de preguntas. (Revise la URL y la configuración CORS)');
                    console.error('Último error:', lastError);
                    // NO marcaremos jsonDataLoaded como true, para que el player no inicie
                    return; 
                }

            } else {
                // No hay JSON externo, usar datos de ejemplo (fallback)
                showLoading('Cargando datos de ejemplo...', 'Preparando contenido');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Si llegamos aquí, o el JSON cargó bien, o estamos usando los datos de ejemplo
            jsonDataLoaded = true;
            
            // Intentar inicializar el video
            tryInitializePlayer();
        }

        function createInteractiveMarkers() {
            const markersContainer = document.getElementById('markers-container');
            if (!markersContainer) return;
            
            if (!questionsData.questions || questionsData.questions.length === 0) {
                console.warn('No hay preguntas disponibles para crear marcadores');
                return;
            }
            
            const existingMarkers = markersContainer.querySelectorAll('.marker');
            existingMarkers.forEach(marker => marker.remove());
            
            const duration = videoDuration || 180;
            
            questionsData.questions.forEach((question, index) => {
                const marker = document.createElement('div');
                marker.className = 'marker';
                const positionPercent = (question.time / duration) * 100;
                marker.style.left = `${positionPercent}%`;
                marker.dataset.questionIndex = index;
                marker.dataset.time = question.time;
                marker.addEventListener('click', () => jumpToQuestion(index));
                
                const tooltip = document.createElement('div');
                tooltip.className = 'marker-tooltip';
                tooltip.textContent = `Actividad ${index + 1} - ${formatTime(question.time)}`;
                marker.appendChild(tooltip);
                
                markersContainer.appendChild(marker);
            });
            
            setupTimelineSlider();
        }

        let timelineSliderSetup = false;
        
        function setupTimelineSlider() {
            if (timelineSliderSetup) return;
            
            const markersContainer = document.getElementById('markers-container');
            const timelineHandle = document.getElementById('timeline-handle');
            const timelineTooltip = document.getElementById('timeline-tooltip');
            
            if (!markersContainer || !timelineHandle || !timelineTooltip) return;
            
            let wasPlaying = false;

            timelineHandle.addEventListener('mousedown', startDrag);
            markersContainer.addEventListener('click', handleTimelineClick);
            markersContainer.addEventListener('mousemove', showTimelineTooltip);
            markersContainer.addEventListener('mouseleave', hideTimelineTooltip);
            
            timelineSliderSetup = true;

            function startDrag(e) {
                isDragging = true;
                wasPlaying = isPlaying;
                if (isPlaying) pauseVideo();
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                e.preventDefault();
            }

            function drag(e) {
                if (!isDragging || !playerReady) return;
                
                const rect = markersContainer.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const percentage = x / rect.width;
                const duration = player.getDuration();
                const newTime = percentage * duration;
                
                updateTimelineHandle(percentage);
                player.seekTo(newTime, true);
                
                timelineTooltip.textContent = formatTime(newTime);
                timelineTooltip.style.left = `${x}px`;
                timelineTooltip.style.opacity = '1';
            }

            function stopDrag() {
                if (!isDragging) return;
                
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                
                if (wasPlaying) {
                    setTimeout(() => playVideo(), 100);
                }
                
                hideTimelineTooltip();
            }

            function handleTimelineClick(e) {
                if (isDragging || !playerReady) return;
                if (e.target.classList.contains('marker') || e.target.closest('.marker')) return;
                
                const rect = markersContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = x / rect.width;
                const duration = player.getDuration();
                const newTime = percentage * duration;
                
                const wasPlayingBefore = isPlaying;
                if (isPlaying) pauseVideo();
                
                player.seekTo(newTime, true);
                
                if (wasPlayingBefore) {
                    setTimeout(() => playVideo(), 200);
                }
            }

            function showTimelineTooltip(e) {
                if (isDragging) return;
                
                const rect = markersContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = x / rect.width;
                const duration = videoDuration || 180;
                const time = percentage * duration;
                
                timelineTooltip.textContent = formatTime(time);
                timelineTooltip.style.left = `${x}px`;
                timelineTooltip.style.opacity = '1';
            }

            function hideTimelineTooltip() {
                if (!isDragging) {
                    timelineTooltip.style.opacity = '0';
                }
            }
        }

        function updateTimelineHandle(percentage) {
            const timelineHandle = document.getElementById('timeline-handle');
            if (timelineHandle) {
                timelineHandle.style.left = `${Math.min(Math.max(percentage * 100, 0), 100)}%`;
            }
        }

        function jumpToQuestion(questionIndex) {
            if (!playerReady || !player) return;
            
            const question = questionsData.questions[questionIndex];
            console.log(`Saltando a pregunta ${questionIndex + 1} en tiempo ${question.time}s`);
            
            if (question.answered) {
                player.seekTo(question.time, true);
                return;
            }
            
            const seekTime = Math.max(0, question.time - 3);
            player.seekTo(seekTime, true);
            question.shown = false;
            
            setTimeout(() => {
                playVideo();
            }, 500);
        }

        function togglePlayPause() {
            const playBtn = document.getElementById('play-pause-btn');
            if (playBtn && playBtn.disabled) return;
            if (!playerReady || !player) return;
            
            try {
                const playerState = player.getPlayerState();
                
                if (playerState === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                } else if (playerState === YT.PlayerState.PAUSED || playerState === YT.PlayerState.CUED || playerState === -1) {
                    player.playVideo();
                } else if (playerState === YT.PlayerState.ENDED) {
                    player.seekTo(0);
                    player.playVideo();
                }
            } catch (error) {
                console.error('Error toggling play/pause:', error);
            }
        }

        function playVideo() {
            if (playerReady && player) {
                try {
                    player.playVideo();
                } catch (error) {
                    console.error('Error playing video:', error);
                }
            }
        }

        function pauseVideo() {
            if (playerReady && player) {
                try {
                    player.pauseVideo();
                } catch (error) {
                    console.error('Error pausing video:', error);
                }
            }
        }

        function startVideoTimer() {
            if (videoTimer) clearInterval(videoTimer);
            
            videoTimer = setInterval(() => {
                if (!playerReady || !player) return;
                
                try {
                    currentVideoTime = player.getCurrentTime();
                    const currentTimeSeconds = Math.floor(currentVideoTime);
                    
                    updateTimelineProgress();
                    updateTimeDisplay();
                    
                    if (isPlaying && questionsEnabled) {
                        questionsData.questions.forEach((question, index) => {
                            if (currentTimeSeconds >= question.time && currentTimeSeconds <= question.time + 1 && !question.shown) {
                                console.log(`🎯 ACTIVANDO pregunta ${index + 1} en tiempo ${currentTimeSeconds}s (objetivo: ${question.time}s)`);
                                question.shown = true;
                                pauseVideo();
                                showQuestion(index);
                            }
                        });
                    }
                    
                } catch (error) {
                    // console.error('Error in video timer:', error);
                }
            }, 250); 
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay() {
            if (!playerReady || !player) return;
            
            try {
                const current = player.getCurrentTime();
                const duration = player.getDuration();
                
                document.getElementById('current-time').textContent = formatTime(current);
                document.getElementById('total-time').textContent = formatTime(duration);
            } catch (error) {
                // console.error('Error updating time display:', error);
            }
        }

        function updateTimelineProgress() {
            if (!playerReady || !player) return;
            
            try {
                const duration = player.getDuration();
                const current = player.getCurrentTime();
                
                if (duration > 0) {
                    const progress = (current / duration) * 100;
                    const progressPercentage = Math.min(Math.max(progress, 0), 100);
                    
                    const timelineProgress = document.getElementById('timeline-progress');
                    if (timelineProgress) {
                        timelineProgress.style.width = `${progressPercentage}%`;
                    }
                    
                    updateTimelineHandle(progressPercentage / 100);
                    updateMarkerStates(current);
                    
                    if (!videoDuration) {
                        videoDuration = duration;
                        createInteractiveMarkers();
                    }
                }
            } catch (error) {
                // console.error('Error updating timeline progress:', error);
            }
        }

        function updateMarkerStates(currentTime) {
            const markers = document.querySelectorAll('.marker');
            
            markers.forEach((marker, index) => {
                const questionTime = parseInt(marker.dataset.time);
                const questionIndex = parseInt(marker.dataset.questionIndex);
                
                if (!questionsData.questions[questionIndex]) return; // Guard
                
                const question = questionsData.questions[questionIndex];
                
                marker.classList.remove('approaching', 'active', 'completed');
                
                if (question && question.answered) {
                    marker.classList.add('completed');
                } else if (Math.abs(currentTime - questionTime) <= 1) {
                    marker.classList.add('active');
                } else if (currentTime >= questionTime - 10 && currentTime < questionTime) {
                    marker.classList.add('approaching');
                }
            });
        }

        function showQuestion(questionIndex) {
            const question = questionsData.questions[questionIndex];
            currentQuestionIndex = questionIndex;
            selectedAnswer = null;
            
            document.getElementById('question-title').textContent = question.question;
            document.getElementById('question-counter').innerHTML = `
                <span class="material-icons">help_outline</span>
                Pregunta ${questionIndex + 1} de ${questionsData.questions.length}
            `;
            
            const questionImage = document.getElementById('question-image');
            if (question.image) {
                questionImage.src = question.image;
                questionImage.style.display = 'block';
            } else {
                questionImage.style.display = 'none';
            }
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.addEventListener('click', () => selectOption(index, button));
                optionsContainer.appendChild(button);
            });
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-icons">send</span> Responder';
            
            document.getElementById('question-overlay').style.display = 'flex';
        }

        function selectOption(index, button) {
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            button.classList.add('selected');
            selectedAnswer = index;
            document.getElementById('submit-btn').disabled = false;
        }

        function submitAnswer() {
            if (selectedAnswer === null) return;
            
            const question = questionsData.questions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.correct_answer;
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-icons">hourglass_empty</span> Procesando...';
            
            try {
                createAudioFeedback(isCorrect ? 'correct' : 'incorrect');
            } catch (error) {
                console.log('Audio feedback not available:', error);
            }
            
            document.querySelectorAll('.option-button').forEach((btn, index) => {
                if (index === question.correct_answer) {
                    btn.classList.add('correct');
                } else if (index === selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
                btn.onclick = null; // Deshabilitar clics
            });
            
            question.answered = true;
            question.correct = isCorrect;
            
            questionsAnswered++;
            if (isCorrect) correctAnswers++;
            
            setTimeout(() => {
                showFeedback(isCorrect, question.feedback);
            }, 1500);
            
            updateProgress();
        }

        function showFeedback(isCorrect, feedback) {
            document.getElementById('question-overlay').style.display = 'none';
            
            const feedbackCard = document.getElementById('feedback-card');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackMessage = document.getElementById('feedback-message');
            
            if (isCorrect) {
                feedbackCard.className = 'feedback-card correct';
                feedbackIcon.innerHTML = '<span class="material-icons">check_circle</span>';
                feedbackIcon.className = 'feedback-icon correct';
                feedbackTitle.textContent = '¡Correcto!';
                feedbackMessage.textContent = feedback.correct;
            } else {
                feedbackCard.className = 'feedback-card incorrect';
                feedbackIcon.innerHTML = '<span class="material-icons">cancel</span>';
                feedbackIcon.className = 'feedback-icon incorrect';
                feedbackTitle.textContent = 'Incorrecto';
                feedbackMessage.textContent = feedback.incorrect;
            }
            
            document.getElementById('feedback-overlay').style.display = 'flex';
        }

        function continueVideo() {
            document.getElementById('feedback-overlay').style.display = 'none';
            
            const markers = document.querySelectorAll('.marker');
            if (markers[currentQuestionIndex]) {
                markers[currentQuestionIndex].classList.add('completed');
            }
            
            playVideo();
        }

        function updateProgress() {
            if (!questionsData.questions || questionsData.questions.length === 0) return;
            const progress = (questionsAnswered / questionsData.questions.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function restartVideo() {
            if (!playerReady || !player) return;
            
            try {
                questionsData.questions.forEach(q => {
                    q.shown = false;
                    q.answered = false;
                    q.correct = false;
                });
                questionsAnswered = 0;
                correctAnswers = 0;
                currentQuestionIndex = 0;
                currentVideoTime = 0;
                
                player.seekTo(0, true);
                player.pauseVideo();
                isPlaying = false;
                document.getElementById('play-pause-btn').innerHTML = '<span class="material-icons">play_arrow</span>';
                
                document.getElementById('question-overlay').style.display = 'none';
                document.getElementById('feedback-overlay').style.display = 'none';
                
                document.querySelectorAll('.marker').forEach(marker => {
                    marker.classList.remove('completed', 'approaching', 'active');
                });
                
                updateTimelineHandle(0);
                
                setTimeout(() => {
                    updateTimelineProgress();
                    updateTimeDisplay();
                }, 200);
                
                updateProgress();
                
                showNotification('Video reiniciado');
                console.log('Video reiniciado correctamente');
            } catch (error) {
                console.error('Error restarting video:', error);
            }
        }



        function toggleAudio() {
            if (!playerReady || !player) return;
            
            isMuted = !isMuted;
            const audioBtn = document.getElementById('audio-btn');
            
            if (isMuted) {
                player.mute();
                audioBtn.innerHTML = '<span class="material-icons">volume_off</span>';
                audioBtn.title = 'Activar audio';
                showNotification('Audio silenciado');
            } else {
                player.unMute();
                audioBtn.innerHTML = '<span class="material-icons">volume_up</span>';
                audioBtn.title = 'Silenciar audio';
                showNotification('Audio activado');
            }
        }

        function toggleFullscreen() {
            const container = document.querySelector('.container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(() => {
                    showNotification('No se pudo activar pantalla completa');
                });
            } else {
                document.exitFullscreen();
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 4px;
                font-size: 14px;
                z-index: 2000;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function showResults() {
            if (!questionsData.questions || questionsData.questions.length === 0) {
                showNotification("Aún no hay preguntas cargadas.");
                return;
            }

            const totalQuestions = questionsData.questions.length;
            const percentage = Math.round((correctAnswers / Math.max(questionsAnswered, 1)) * 100);
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 32px;
                border-radius: 16px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #2d3748;">📊 Resultados del Video</h3>
                <p style="margin: 10px 0; color: #4a5568;"><strong>Preguntas respondidas:</strong> ${questionsAnswered}/${totalQuestions}</p>
                <p style="margin: 10px 0; color: #4a5568;"><strong>Respuestas correctas:</strong> ${correctAnswers}</p>
                <p style="margin: 10px 0; color: #4a5568;"><strong>Porcentaje de aciertos:</strong> ${percentage}%</p>
                <button onclick="this.closest('div').parentElement.remove()" style="
                    background: #1768ac;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-top: 20px;
                    font-weight: 600;
                ">Cerrar</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // SDK de elementos
        async function onConfigChange(config) {
            const descriptionElement = document.getElementById('video-description');
            
            if (descriptionElement) {
                descriptionElement.textContent = config.video_description || defaultConfig.video_description;
            }
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["video_description", config.video_description || defaultConfig.video_description]
            ]);
        }

        // Inicializar SDK (solo si está disponible)
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
            });
        }
    </script>
</body>
</html>