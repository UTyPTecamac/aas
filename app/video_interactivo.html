<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Interactivo Mejorado</title>
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Estilos básicos y contenedor */
    html, body { height:100%; margin:0; padding:0; font-family:Inter, Arial, sans-serif; background:transparent; }
    .container { display:flex; flex-direction:column; height:100vh; }
    .video-container { flex:1; display:flex; align-items:center; justify-content:center; background:#000; }
    .video-aspect { width:100%; max-width:1200px; aspect-ratio:16/9; position:relative; }
    iframe.video-player { width:100%; height:100%; border:0; background:#000; }

    /* Overlay splash / estado */
    .video-state-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; color:#fff; z-index:10; background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.65)); pointer-events:auto; }
    .splash-play { width:90px; height:90px; border-radius:50%; border:3px solid #fff; display:flex; align-items:center; justify-content:center; font-size:48px; cursor:pointer; background:rgba(255,255,255,0.08); }
    .splash-title { margin-top:16px; font-size:18px; }

    /* Controles inferiores */
    .controls { background:#000; display:flex; align-items:center; gap:12px; padding:10px 14px; color:#fff; }
    .play-pause { width:40px; height:40px; border-radius:50%; background:#1768ac; border:none; color:#fff; cursor:pointer; }
    .time { font-family:monospace; min-width:90px; }
    .markers-container { flex:1; height:8px; background:#e6e6e6; border-radius:6px; position:relative; cursor:pointer; }
    .marker { position:absolute; top:-2px; width:12px; height:12px; border-radius:50%; background:#1768ac; border:2px solid #fff; transform:translateX(-50%); }
    .timeline-progress { position:absolute; left:0; top:0; bottom:0; width:0%; background:#1768ac; border-radius:6px; }

    /* Mensajes de error / info */
    .message { padding:12px; background:#fff5f5; color:#742a2a; border-radius:6px; margin:8px; display:none; }

    @media (max-width:600px){ .splash-play{width:68px;height:68px;font-size:34px;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="video-container">
      <div class="video-aspect">
        <iframe id="video-player" class="video-player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen src=""></iframe>

        <div id="video-state-overlay" class="video-state-overlay">
          <div id="splash-play" class="splash-play"><span class="material-icons">play_arrow</span></div>
          <div class="splash-title">Pulsa para iniciar</div>
          <div id="splash-sub" style="margin-top:8px; font-size:13px; color:rgba(255,255,255,0.8)">Cargando...</div>
        </div>

      </div>
    </div>

    <div class="controls">
      <button id="play-pause-btn" class="play-pause" disabled><span class="material-icons">play_arrow</span></button>
      <div class="time"><span id="current-time">0:00</span> / <span id="total-time">0:00</span></div>
      <div class="markers-container" id="markers-container"><div class="timeline-progress" id="timeline-progress"></div></div>
    </div>

    <div id="message" class="message"></div>
  </div>

  <script>
    // ---------------------- Config y estado ----------------------
    let videoId = 'jCcZfY04at4'; // fallback
    let jsonFile = null;
    let videoParamProvided = false;

    let youtubeAPIReady = false;
    let jsonDataLoaded = false;
    let playerInitialized = false;
    let playerReady = false;
    let player = null;
    let questions = [];
    let videoDuration = 0;
    let videoTimer = null;
    let playerInitializationWatchdog = null;

    // ---------------------- Utilidades ----------------------
    function showMessage(text, isError = true) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.style.display = 'block';
      el.style.background = isError ? '#fff5f5' : '#e6ffef';
      el.style.color = isError ? '#742a2a' : '#155724';
      setTimeout(()=> el.style.display = 'none', 6000);
    }

    function extractYouTubeId(urlOrId) {
      if (!urlOrId) return null;
      if (/^[a-zA-Z0-9_-]{11}$/.test(urlOrId)) return urlOrId;
      const patterns = [ /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/, /youtube\.com\/.*[?&]v=([a-zA-Z0-9_-]{11})/ ];
      for (const p of patterns) { const m = urlOrId.match(p); if (m && m[1]) return m[1]; }
      return null;
    }

    function formatTime(s) { s = Math.floor(s||0); const m = Math.floor(s/60); const sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; }

    // ---------------------- Lectura parámetros URL ----------------------
    function getUrlParams(){
      const params = new URLSearchParams(window.location.search);
      const v = params.get('video'); const j = params.get('json');
      if (v){ const id = extractYouTubeId(v); if (id){ videoId = id; videoParamProvided = true; } }
      if (j) jsonFile = decodeURIComponent(j);
    }

    // ---------------------- Carga JSON con reintentos ----------------------
    async function fetchWithRetries(url, retries=3, delay=1000){
      for (let i=0;i<retries;i++){
        try{
          const controller = new AbortController();
          const timeout = setTimeout(()=>controller.abort(), 10000);
          const res = await fetch(url, { signal: controller.signal, cache: 'no-cache' });
          clearTimeout(timeout);
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(err){
          console.warn('fetch fail', err);
          if (i===retries-1) throw err;
          await new Promise(r=>setTimeout(r, delay*(i+1)));
        }
      }
    }

    async function loadQuestionsData(){
      if (!jsonFile){
        // fallback simple
        questions = [ {id:1, time:5, type:'text', content:{title:'Bienvenido', text:'Ejemplo'}} , {id:2, time:15, type:'mc', content:{question:'¿Ejemplo?', options:['A','B'], correct:0}} ];
        jsonDataLoaded = true; if (youtubeAPIReady) tryInitializePlayer(); return;
      }
      try{
        const data = await fetchWithRetries(jsonFile, 3);
        if (!data) throw new Error('JSON vacío');
        if (data.video_id && !videoParamProvided){ const id = extractYouTubeId(data.video_id); if (id) videoId = id; }
        questions = data.questions || [];
        jsonDataLoaded = true;
        if (youtubeAPIReady) tryInitializePlayer();
      }catch(err){
        console.error('No se pudo cargar JSON', err);
        showMessage('No se pudo cargar el archivo de preguntas. '+(err.message||''));
      }
    }

    // ---------------------- API YouTube ----------------------
    function onYouTubeIframeAPIReady(){
      console.log('YouTube API ready');
      youtubeAPIReady = true;
      if (window.youtubeApiTimeout){ clearTimeout(window.youtubeApiTimeout); window.youtubeApiTimeout = null; }
      loadQuestionsData();
    }

    function tryInitializePlayer(){
      if (playerInitialized) return;
      if (!youtubeAPIReady || !jsonDataLoaded) return;
      playerInitialized = true;
      updateSplash('Preparando video...', true);

      // watchdog extendido
      playerInitializationWatchdog = setTimeout(()=>{
        if (!playerReady){ showMessage('El reproductor tardó demasiado en inicializar. Intenta recargar la página.'); }
      }, 25000);

      try{
        // IMPORTANT: Pasar videoId aquí evita problemas donde el player no responde
        player = new YT.Player('video-player', {
          videoId: videoId,
          width: '100%',
          height: '100%',
          playerVars: { controls:0, rel:0, enablejsapi:1, modestbranding:1, iv_load_policy:3 },
          events: { onReady:onPlayerReady, onStateChange:onPlayerStateChange, onError:onPlayerError }
        });
      }catch(err){
        console.warn('Primera inicialización falló, reintentando...');
        setTimeout(()=>{
          try{
            player = new YT.Player('video-player', { videoId: videoId, width:'100%', height:'100%', playerVars:{controls:0,rel:0,enablejsapi:1,modestbranding:1,iv_load_policy:3}, events:{ onReady:onPlayerReady, onStateChange:onPlayerStateChange, onError:onPlayerError } });
          }catch(e){ console.error('Reintento fallido', e); showMessage('No se pudo inicializar el reproductor.'); }
        }, 2500);
      }
    }

    function onPlayerReady(e){
      console.log('Player ready');
      if (playerInitializationWatchdog){ clearTimeout(playerInitializationWatchdog); playerInitializationWatchdog = null; }
      playerReady = true; updateSplash('Listo', false);

      // Try play/pause trick to unlock audio context and ensure control commands work
      try{ player.unMute(); player.playVideo(); setTimeout(()=>player.pauseVideo(), 250); }catch(e){}

      try{ videoDuration = player.getDuration(); }catch(e){ videoDuration = 180; }
      updateTimeDisplay(); createMarkers();
      document.getElementById('play-pause-btn').disabled = false;
      setupControls();

      // hide overlay so user can interact with the player controls if present
      document.getElementById('video-state-overlay').style.display = 'flex';
    }

    function onPlayerError(e){ console.error('YT Error', e.data); if (playerInitializationWatchdog){ clearTimeout(playerInitializationWatchdog); playerInitializationWatchdog=null; } let msg='Error al cargar el video.'; if (e.data===150||e.data===101) msg='El propietario del video no permite reproducción en este sitio.'; if (e.data===2) msg='ID de video inválido.'; showMessage(msg); updateSplash(msg, false); }

    function onPlayerStateChange(e){
      const state = e.data;
      const btn = document.getElementById('play-pause-btn');
      if (state==YT.PlayerState.PLAYING){ btn.innerHTML='<span class="material-icons">pause</span>'; startTimer(); document.getElementById('video-state-overlay').style.display='none'; }
      else if (state==YT.PlayerState.PAUSED){ btn.innerHTML='<span class="material-icons">play_arrow</span>'; stopTimer(); document.getElementById('video-state-overlay').style.display='flex'; }
      else if (state==YT.PlayerState.ENDED){ btn.innerHTML='<span class="material-icons">replay</span>'; stopTimer(); document.getElementById('video-state-overlay').style.display='flex'; }
    }

    // ---------------------- Controls ----------------------
    function setupControls(){
      document.getElementById('play-pause-btn').addEventListener('click', ()=>{
        if (!playerReady) return;
        const st = player.getPlayerState();
        if (st===YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo();
      });

      document.getElementById('splash-play').addEventListener('click', ()=>{
        if (!playerReady) { showMessage('El reproductor aún se está preparando.'); return; }
        // user gesture - should allow playback even if autoplay was blocked
        try{ player.playVideo(); }catch(e){ console.error('playVideo failed', e); showMessage('No se pudo iniciar reproducción.'); }
      });

      // timeline click
      const markersContainer = document.getElementById('markers-container');
      markersContainer.addEventListener('click',(ev)=>{
        if (!playerReady) return;
        const rect = markersContainer.getBoundingClientRect();
        const x = ev.clientX - rect.left; const perc = Math.max(0, Math.min(x/rect.width,1));
        const t = (videoDuration||player.getDuration())*perc; player.seekTo(t, true);
      });
    }

    // ---------------------- Timer y marcadores ----------------------
    function startTimer(){ if (videoTimer) clearInterval(videoTimer); videoTimer = setInterval(()=>{
      if (!playerReady) return; try{ const curr = player.getCurrentTime(); document.getElementById('current-time').textContent = formatTime(curr); updateProgress(curr); checkInteractions(Math.floor(curr)); }catch(e){} }, 250); }
    function stopTimer(){ if (videoTimer) clearInterval(videoTimer); videoTimer = null; }
    function updateTimeDisplay(){ try{ const d = player.getDuration(); document.getElementById('total-time').textContent = formatTime(d); }catch(e){} }

    function updateProgress(current){ try{ const dur = player.getDuration(); const perc = (current/dur)*100; document.getElementById('timeline-progress').style.width = perc+'%'; }catch(e){} }

    function createMarkers(){ const container = document.getElementById('markers-container'); container.querySelectorAll('.marker').forEach(n=>n.remove()); if (!questions||questions.length===0) return; const dur = videoDuration||player.getDuration()||180; questions.forEach((q,i)=>{ const m = document.createElement('div'); m.className='marker'; const left = Math.min(100, Math.max(0, (q.time/dur)*100)); m.style.left = left+'%'; m.title = (q.title||q.question||'Actividad') + ' - '+ formatTime(q.time); container.appendChild(m); }); }

    function checkInteractions(currSec){ if (!questions) return; questions.forEach((q, i)=>{ if (!q._shown && currSec>=q.time && currSec<=q.time+1){ q._shown = true; // aquí podrías mostrar overlay de pregunta
          console.log('Mostrar interacción', q);
        }}); }

    // ---------------------- Splash helpers ----------------------
    function updateSplash(text, loading=true){ const splash = document.getElementById('video-state-overlay'); const sub = document.getElementById('splash-sub'); sub.textContent = text||''; if (loading){ splash.style.display='flex'; } else { splash.style.display='flex'; setTimeout(()=>{ /* mantener visible como 'Play' */ }, 200); } }

    // ---------------------- Inicio DOM ----------------------
    document.addEventListener('DOMContentLoaded', ()=>{
      getUrlParams();
      document.getElementById('play-pause-btn').disabled = true;

      // mostrar spinner texto
      updateSplash('Cargando API de YouTube...', true);

      // Set iframe src inmediatamente con origin correcto
      const iframe = document.getElementById('video-player');
      iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&controls=0&modestbranding=1&iv_load_policy=3&origin=${location.protocol}//${location.host}`;
      // Ensure iframe allows autoplay and picture-in-picture
      iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');

      // Esperar a que el iframe físico haya cargado
      iframe.addEventListener('load', ()=>{
        console.log('Iframe onload');
        // Si la API ya está lista y JSON cargado, inicializar
        if (youtubeAPIReady && jsonDataLoaded) tryInitializePlayer();
      });

      // Timeout global para la API (adblock o problemas de red)
      if (!window.youtubeApiTimeout){ window.youtubeApiTimeout = setTimeout(()=>{ if (!youtubeAPIReady){ showMessage('No se pudo conectar con YouTube. Desactiva ad-block o revisa la conexión.'); updateSplash('Error cargando YouTube', false); } }, 30000); }

      // Iniciar carga del JSON (onYouTubeIframeAPIReady también lo hará, pero cargamos aquí si la API tarda)
      loadQuestionsData();
    });

    // Exponer onYouTubeIframeAPIReady al global (necesario para la API)
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

  </script>
</body>
</html>